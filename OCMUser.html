<!DOCTYPE html>
<html>
<head>
    <!-- Top bar dependencies -->
    <link rel="icon" href="favicon.ico">
    <script src="app-config.js"></script>
    <script src="auth-storage.js"></script>
    <script src="topbar.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <meta charset="UTF-8">
    <title>OCM Merchant Panel</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="icon" href="favicon.ico">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            max-width: 1250px;
        }

        h1, h2, h3 {
            margin-top: 0;
        }

        .small {
            font-size: 12px;
            color: #555;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 10px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 6px;
            font-size: 13px;
            vertical-align: top;
        }

        th {
            background: #f5f5f5;
        }

        input, button, select {
            padding: 6px;
            font-size: 13px;
        }

        .radio-wrap {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .flex {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        .section {
            border: 1px solid #ccc;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 22px;
            background: #fff;
        }

        .grid {
            display: grid;
            gap: 10px;
            grid-template-columns: repeat(auto-fit,minmax(220px,1fr));
        }

        .mono {
            font-family: Consolas, monospace;
        }

        .inactive {
            opacity: .5;
        }

        .status-open {
            color: #2e7d32;
            font-weight: bold;
        }

        .status-closed {
            color: #c62828;
            font-weight: bold;
        }

        .warn {
            color: #c00;
            font-size: 12px;
            margin-left: 6px;
        }

        .edit-panel {
            background: #fcfcfc;
            padding: 10px;
            border: 1px solid #bbb;
            border-radius: 6px;
            margin-top: 6px;
        }

        .hidden {
            display: none;
        }

        .stack-note {
            font-size: 11px;
            color: #666;
        }

        .badge-sell {
            background: #e9ffe8;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .badge-buy {
            background: #e8f7ff;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .truncate {
            max-width: 160px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .footer-note {
            font-size: 11px;
            color: #777;
            margin-top: 30px;
        }
        /* Shared top bar styling */
        #topBar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 52px;
            background: #222;
            color: #fff;
            display: flex;
            align-items: center;
            padding: 0 20px;
            z-index: 1000;
            font-size: 14px;
            gap: 12px;
        }

            #topBar a, #topBar button {
                color: #fff;
                text-decoration: none;
                margin-right: 16px;
                background: none;
                border: none;
                cursor: pointer;
            }

            #topBar .right {
                margin-left: auto;
                display: flex;
                gap: 12px;
                align-items: center;
                flex-wrap: wrap;
            }

        body.withTopBar {
            padding-top: 72px;
        }

        .balance-chip {
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(255,255,255,0.08);
            white-space: nowrap;
        }

        .balance-you.positive {
            color: #2ecc71;
        }

        .balance-you.negative {
            color: #ff5252;
        }

        .balance-target {
            color: #f0c200;
        }

        #orderPopup {
            position: absolute;
            top: 52px;
            right: 100px;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 8px;
            display: none;
            min-width: 260px;
            z-index: 1100;
            color: #000;
        }

        #orderStatusBall {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #777;
            cursor: pointer;
        }

        .status-pending {
            background: #f0c200 !important;
        }

        .status-error {
            background: #e74c3c !important;
        }

        .status-none {
            background: #777 !important;
        }

        .order-link {
            color: #66c;
            text-decoration: underline;
            cursor: pointer;
        }
    </style>
    <script src="app-config.js"></script>
    <script src="auth-storage.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
        const WEB_APP_URL = window.WEB_APP_URL || 'https://yellow-king-52c6.vilhokettu1.workers.dev/exec';
        const OAUTH_CLIENT_ID = window.OAUTH_CLIENT_ID || '857098772457-kuvq861sa844esf2jc4b7av1pnlmnn1c.apps.googleusercontent.com';
        const PRICE_SHEET_URL = "https://docs.google.com/spreadsheets/d/1_meliJtuKSDwEWRDh1gldcsD-pSjDgIND3dcE1mCjCo/gviz/tq?tqx=out:json&gid=0";

        let googleIdToken = null;
        let currentUser = null;
        let items = [];
        let myListings = [];
        let editingId = null;

        function byId(i) { return document.getElementById(i); }
        function fmt2(v) { v = Number(v) || 0; let s = v.toFixed(2); return s.replace(/\.?0+$/, ''); }
        function fmt4(v) { v = Number(v) || 0; return v.toFixed(4); }

        function initLogin() {
            if (!window.google || !google.accounts || !google.accounts.id) return;
            google.accounts.id.initialize({
                client_id: OAUTH_CLIENT_ID,
                callback: cred => onLogin(cred.credential),
                ux_mode: 'popup'
            });
            google.accounts.id.renderButton(byId('loginBtnArea'), { theme: 'outline', size: 'medium' });
        }

        async function restore() {
            if (!window.initAuthFromStorage) return;
            const res = await window.initAuthFromStorage();
            if (res.ok) onLogin(res.idToken, true);
        }

        async function onLogin(token, silent = false) {
            googleIdToken = token;
            try {
                const r = await fetch(`${WEB_APP_URL}?action=me&idToken=${encodeURIComponent(token)}`);
                const j = await r.json();
                if (!j.ok) throw new Error(j.error || 'me failed');
                currentUser = j.data.user;
                currentUser.isAdmin = !!j.data.isAdmin;
                byId('authStatus').textContent = `Logged as ${currentUser.email}`;
                byId('logoutBtn').style.display = 'inline-block';
                byId('loginBtnArea').style.display = 'none';
                await loadPriceSheet();
                await loadMyListings();
            } catch (e) {
                if (!silent) byId('authStatus').textContent = 'Auth failed: ' + e.message;
            }
        }

        function logout() {
            googleIdToken = null; currentUser = null;
            window.clearSavedIdToken && window.clearSavedIdToken();
            byId('authStatus').textContent = 'Logged out.';
            byId('logoutBtn').style.display = 'none';
            byId('loginBtnArea').style.display = 'block';
            byId('tbListings').innerHTML = '';
        }

        async function loadPriceSheet() {
            byId('itemsStatus').textContent = 'Loading items...';
            try {
                const txt = await fetch(PRICE_SHEET_URL).then(r => r.text());
                let payloadText = txt;
                const start = payloadText.indexOf('('), end = payloadText.lastIndexOf(')');
                if (start > -1 && end > start) payloadText = payloadText.slice(start + 1, end);
                const json = JSON.parse(payloadText);
                const rows = json?.table?.rows || [];
                items = rows.map(row => {
                    const c = row.c || [];
                    const name = c[0]?.v ?? "";
                    const bundleSize = Number(c[4]?.v ?? 1);
                    if (!name) return null;
                    return { name: String(name), bundleSize: bundleSize || 1 };
                }).filter(Boolean);
                byId('itemsStatus').textContent = `Loaded ${items.length} items.`;
                rebuildItemSelect();
            } catch (e) {
                items = []; byId('itemsStatus').textContent = 'Item load error: ' + e.message;
            }
        }

        function rebuildItemSelect() {
            const sel = byId('refItemInput');
            sel.setAttribute('list', 'refItemsDatalist');
            const dl = byId('refItemsDatalist');
            dl.innerHTML = '';
            items.forEach(i => {
                const opt = document.createElement('option');
                opt.value = i.name;
                dl.appendChild(opt);
            });
        }

        async function loadMyListings() {
            if (!googleIdToken) { byId('listingsMsg').textContent = 'Login first.'; return; }
            byId('listingsMsg').textContent = 'Loading...';
            try {
                const r = await fetch(`${WEB_APP_URL}?action=listMyListings&idToken=${encodeURIComponent(googleIdToken)}`);
                const j = await r.json();
                if (!j.ok) throw new Error(j.error || 'listMyListings failed');
                const d = (j.data && j.data.listings) ? j.data.listings : [];
                myListings = d;
                renderMyListings();
                byId('listingsMsg').textContent = `Loaded ${d.length}`;
            } catch (e) {
                byId('listingsMsg').textContent = 'Error: ' + e.message;
            }
        }

        function renderMyListings() {
            const tb = byId('tbListings'); tb.innerHTML = '';
            myListings.forEach(l => {
                const qtyInd = (l.remainingQuantity === '' || l.remainingQuantity == null) ? 0 : Number(l.remainingQuantity || 0);
                const ss = Number(l.stackSize || 1) || 1;
                const qtyStacks = Math.floor(qtyInd / ss);
                const tr = document.createElement('tr');
                tr.className = l.status ? '' : 'inactive';
                tr.innerHTML = `
                            <td class="truncate">${l.itemName || ''}</td>
                            <td>${l.type === 'SELL' ? '<span class="badge-sell">SELL</span>' : '<span class="badge-buy">BUY</span>'}</td>
                            <td>
                               <div class="mono">stk: ${fmt2(l.priceStack)}</div>
                               <div class="mono">ind: ${fmt2(l.priceInd)}</div>
                               <div class="stack-note">stackSize=${ss}</div>
                            </td>
                            <td>
                               <div>stk stock/demand: ${qtyStacks}</div>
                               <div>ind stock/demand: ${qtyInd}</div>
                            </td>
                            <td>${l.status ? '<span class="status-open">OPEN</span>' : '<span class="status-closed">CLOSED</span>'}</td>
                            <td>
                               <button data-edit="${l.listingId}">Edit</button>
                               <button data-toggle="${l.listingId}">${l.status ? 'Close' : 'Open'}</button>
                               <button data-delete="${l.listingId}">Delete</button>
                            </td>
                        `;
                tb.appendChild(tr);
            });
        }

        function resetCreateForms() {
            byId('refItemInput').value = '';
            byId('refQtyInd').value = '';
            byId('refPrice').value = '';
            byId('refPriceModeInd').checked = true;
            byId('refSideSell').checked = true;
            byId('customName').value = '';
            byId('customStackSize').value = '';
            byId('customQtyInd').value = '';
            byId('customPrice').value = '';
            byId('customPriceModeInd').checked = true;
            byId('customSideSell').checked = true;
        }

        async function createReferencedListing() {
            if (!googleIdToken) { alert('Login first'); return; }
            const itemName = byId('refItemInput').value.trim();
            const qtyInd = Number(byId('refQtyInd').value || 0);
            const priceRaw = Number(byId('refPrice').value || 0);
            const priceMode = byId('refPriceModeStack').checked ? 'stk' : 'ind';
            const side = byId('refSideBuy').checked ? 'BUY' : 'SELL';
            if (!itemName || qtyInd <= 0 || priceRaw <= 0) { alert('Fill all fields'); return; }
            const item = items.find(i => i.name.toLowerCase() === itemName.toLowerCase());
            const stackSize = item ? Number(item.bundleSize || 1) || 1 : 1;
            const body = {
                action: 'createListing',
                idToken: googleIdToken,
                type: side,
                itemName,
                quantity: qtyInd,
                price: priceRaw,
                priceUnit: priceMode,
                stackSize: stackSize,
                sourceItemId: item ? item.name : '',
                status: true
            };
            await postListing(body, 'Referenced listing created.');
        }

        async function createCustomListing() {
            if (!googleIdToken) { alert('Login first'); return; }
            const name = byId('customName').value.trim();
            let stackSize = Number(byId('customStackSize').value || 0);
            const qtyInd = Number(byId('customQtyInd').value || 0);
            const priceRaw = Number(byId('customPrice').value || 0);
            const priceMode = byId('customPriceModeStack').checked ? 'stk' : 'ind';
            const side = byId('customSideBuy').checked ? 'BUY' : 'SELL';
            if (!name || qtyInd <= 0 || priceRaw <= 0 || stackSize <= 0) { alert('Fill all fields'); return; }
            stackSize = Math.max(1, Math.floor(stackSize));
            const body = {
                action: 'createListing',
                idToken: googleIdToken,
                type: side,
                itemName: name,
                quantity: qtyInd,
                price: priceRaw,
                priceUnit: priceMode,
                stackSize: stackSize,
                sourceItemId: '',
                status: true
            };
            await postListing(body, 'Custom listing created.');
        }

        async function postListing(body, okMsg) {
            const msg = byId('createMsg');
            msg.textContent = 'Creating...';
            try {
                const r = await fetch(WEB_APP_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                const j = await r.json();
                if (!j.ok) throw new Error(j.error || 'createListing failed');
                msg.textContent = okMsg;
                resetCreateForms();
                loadMyListings();
            } catch (e) {
                msg.textContent = 'Error: ' + e.message;
            }
        }

        function openEdit(listingId) {
            const l = myListings.find(x => x.listingId === listingId);
            if (!l) { alert('Listing not found'); return; }
            editingId = listingId;
            byId('editPanel').classList.remove('hidden');
            byId('editItemName').textContent = l.itemName;
            byId('editListingId').textContent = l.listingId;
            byId('editSide').textContent = l.type;
            byId('editStackSize').value = l.stackSize;
            byId('editQtyInd').value = l.remainingQuantity ?? 0;
            // Price input: show raw in chosen mode; default to individual
            byId('editPriceModeInd').checked = true;
            byId('editPriceValue').value = fmt2(l.priceInd);
            byId('editStatusOpen').checked = !!l.status;
            updateEditDerived();
        }

        function closeEdit() {
            editingId = null;
            byId('editPanel').classList.add('hidden');
        }

        function updateEditDerived() {
            const stackSize = Number(byId('editStackSize').value || 1) || 1;
            const qtyInd = Number(byId('editQtyInd').value || 0);
            const mode = byId('editPriceModeStack').checked ? 'stk' : 'ind';
            const priceInput = Number(byId('editPriceValue').value || 0);
            const indPrice = mode === 'stk' ? (priceInput / stackSize) : priceInput;
            byId('editDerivedPriceInd').textContent = isFinite(indPrice) ? fmt4(indPrice) : '0';
            byId('editDerivedPriceStack').textContent = isFinite(indPrice) ? fmt2(indPrice * stackSize) : '0';
            byId('editDerivedQtyStacks').textContent = stackSize > 0 ? Math.floor(qtyInd / stackSize) : 0;
        }

        async function saveEdit() {
            if (!googleIdToken || !editingId) { alert('Nothing to save'); return; }
            const listingId = editingId;
            const stackSize = Number(byId('editStackSize').value || 1) || 1;
            const qtyInd = Number(byId('editQtyInd').value || 0);
            const mode = byId('editPriceModeStack').checked ? 'stk' : 'ind';
            const priceRaw = Number(byId('editPriceValue').value || 0);
            const status = byId('editStatusOpen').checked;
            if (priceRaw <= 0 || qtyInd <= 0 || stackSize <= 0) { alert('Fill valid values'); return; }
            const body = {
                action: 'updateListing',
                idToken: googleIdToken,
                listingId,
                price: priceRaw,
                priceUnit: mode,
                quantity: qtyInd,
                stackSize,
                status
            };
            const msg = byId('editMsg');
            msg.textContent = 'Saving...';
            try {
                const r = await fetch(WEB_APP_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                const j = await r.json();
                if (!j.ok) throw new Error(j.error || 'updateListing failed');
                msg.textContent = 'Saved.';
                await loadMyListings();
                openEdit(listingId); // refresh panel values
            } catch (e) {
                msg.textContent = 'Error: ' + e.message;
            }
        }

        async function toggleListing(listingId) {
            if (!googleIdToken) { alert('Login first'); return; }
            const l = myListings.find(x => x.listingId === listingId);
            if (!l) return;
            const body = { action: 'toggleListingStatus', idToken: googleIdToken, listingId, status: !l.status };
            const msg = byId('listingsMsg');
            msg.textContent = 'Toggling...';
            try {
                const r = await fetch(WEB_APP_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                const j = await r.json();
                if (!j.ok) throw new Error(j.error || 'toggleListingStatus failed');
                msg.textContent = 'Status toggled.';
                loadMyListings();
                if (editingId === listingId) openEdit(listingId);
            } catch (e) {
                msg.textContent = 'Error: ' + e.message;
            }
        }

        async function deleteListing(listingId) {
            if (!googleIdToken) { alert('Login first'); return; }
            if (!confirm('Delete listing? This closes it and zeroes remaining quantity.')) return;
            const body = { action: 'deleteListing', idToken: googleIdToken, listingId };
            const msg = byId('listingsMsg');
            msg.textContent = 'Deleting...';
            try {
                const r = await fetch(WEB_APP_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                const j = await r.json();
                if (!j.ok) throw new Error(j.error || 'deleteListing failed');
                msg.textContent = 'Deleted.';
                if (editingId === listingId) closeEdit();
                loadMyListings();
            } catch (e) {
                msg.textContent = 'Error: ' + e.message;
            }
        }

        document.addEventListener('click', ev => {
            const t = ev.target;
            if (t.dataset && t.dataset.edit) openEdit(t.dataset.edit);
            if (t.dataset && t.dataset.toggle) toggleListing(t.dataset.toggle);
            if (t.dataset && t.dataset.delete) deleteListing(t.dataset.delete);
        });

        window.onload = () => {
            initLogin();
            restore();
            const saved = window.getSavedIdToken && window.getSavedIdToken();
            if (saved) onLogin(saved, true);
            byId('refPriceModeInd').onchange = () => syncReferencedMode();
            byId('refPriceModeStack').onchange = () => syncReferencedMode();
            byId('customPriceModeInd').onchange = () => syncCustomMode();
            byId('customPriceModeStack').onchange = () => syncCustomMode();
            // Edit mode dynamic updates
            ['editStackSize', 'editQtyInd', 'editPriceValue', 'editPriceModeInd', 'editPriceModeStack'].forEach(id => {
                byId(id).addEventListener('input', updateEditDerived);
                byId(id).addEventListener('change', updateEditDerived);
            });
            byId('btnCreateRef').onclick = createReferencedListing;
            byId('btnCreateCustom').onclick = createCustomListing;
            byId('btnSaveEdit').onclick = saveEdit;
            byId('btnCancelEdit').onclick = closeEdit;
        };

        function syncReferencedMode() {
            // Just visual; canonical price always per-ind stored after creation
            const mode = byId('refPriceModeStack').checked ? 'stk' : 'ind';
            byId('refPriceModeIndicator').textContent = mode === 'stk' ? 'Stack price' : 'Individual price';
        }
        function syncCustomMode() {
            const mode = byId('customPriceModeStack').checked ? 'stk' : 'ind';
            byId('customPriceModeIndicator').textContent = mode === 'stk' ? 'Stack price' : 'Individual price';
        }
    </script>
</head>
<body>
    <!-- Shared Top Bar -->
    <div id="topBar">
        <div><strong>Vak Store</strong></div>
        <button onclick="navigateStore()">Store</button>
        <button onclick="navigateHistory()">Account History</button>
        <button onclick="navigateOCM()">OCM</button>
        <button onclick="navigateMerchant()">OCM Merchant</button>
        <button id="adminPanelBtn" style="display:none;" onclick="navigateAdmin()">Admin Panel</button>
        <div class="right">
            <button id="btnLogin" onclick="startLogin()">Login</button>
            <div id="orderStatusBall" title="Orders status"></div>
            <div id="orderPopup">
                <div style="font-weight:bold;margin-bottom:6px;">Your open orders</div>
                <div id="orderPopupBody" class="small"></div>
            </div>
            <span id="topBalanceTarget" class="small balance-chip balance-target" style="display:none;"></span>
            <span id="topBalance" class="small balance-chip balance-you" style="display:none;"></span>
            <span id="topUser" class="small"></span>
            <button id="btnLogout" style="display:none;" onclick="logout()">Logout</button>
        </div>
    </div>
    <script>
        // Minimal nav helpers (works even if topbar.js already offers them)
        function navigateStore() { location.href = 'index.html'; }
        function navigateHistory() { location.href = 'AccountHistory.html'; }
        function navigateOCM() { location.href = 'OCMHome.html'; }
        function navigateMerchant() { location.href = 'OCMUser.html'; }
        function navigateAdmin() { location.href = 'Admin.html'; }
        // Initialize shared top bar if helper exists
        document.body.classList.add('withTopBar');
        if (window.initSharedTopBar) { window.initSharedTopBar(); }
    </script>
    <h1>OCM Merchant Panel</h1>
    <div id="authStatus" class="small">Not logged in.</div>
    <div id="loginBtnArea"></div>
    <button id="logoutBtn" style="display:none;" onclick="logout()">Logout</button>

    <div class="section">
        <h2>Create Referenced Listing</h2>
        <div id="itemsStatus" class="small">Items not loaded yet.</div>
        <div class="grid">
            <div>
                <label>Item (sheet): <input id="refItemInput" list="refItemsDatalist" placeholder="Search item"></label>
                <datalist id="refItemsDatalist"></datalist>
            </div>
            <div>
                <label>Quantity (ind): <input id="refQtyInd" type="number" min="1" placeholder="e.g. 128"></label>
                <div class="stack-note">System derives stack count.</div>
            </div>
            <div>
                <label>Price: <input id="refPrice" type="number" min="0.01" step="0.01" placeholder="e.g. 2.5"></label>
                <div class="radio-wrap">
                    <label><input type="radio" name="refPriceMode" id="refPriceModeInd" checked> ind price</label>
                    <label><input type="radio" name="refPriceMode" id="refPriceModeStack"> stk price</label>
                </div>
                <div class="stack-note" id="refPriceModeIndicator">Individual price</div>
            </div>
            <div>
                <div class="radio-wrap">
                    <label><input type="radio" name="refSide" id="refSideSell" checked> SELL (provide stock)</label>
                    <label><input type="radio" name="refSide" id="refSideBuy"> BUY (provide demand)</label>
                </div>
            </div>
        </div>
        <button id="btnCreateRef">Create Referenced Listing</button>
    </div>

    <div class="section">
        <h2>Create Fully Custom Listing</h2>
        <div class="grid">
            <div>
                <label>Custom Name: <input id="customName" type="text" placeholder="Name"></label>
            </div>
            <div>
                <label>Stack Size: <input id="customStackSize" type="number" min="1" placeholder="e.g. 64"></label>
            </div>
            <div>
                <label>Quantity (ind): <input id="customQtyInd" type="number" min="1" placeholder="e.g. 64"></label>
            </div>
            <div>
                <label>Price: <input id="customPrice" type="number" min="0.01" step="0.01" placeholder="e.g. 10"></label>
                <div class="radio-wrap">
                    <label><input type="radio" name="customPriceMode" id="customPriceModeInd" checked> ind price</label>
                    <label><input type="radio" name="customPriceMode" id="customPriceModeStack"> stk price</label>
                </div>
                <div class="stack-note" id="customPriceModeIndicator">Individual price</div>
            </div>
            <div>
                <div class="radio-wrap">
                    <label><input type="radio" name="customSide" id="customSideSell" checked> SELL</label>
                    <label><input type="radio" name="customSide" id="customSideBuy"> BUY</label>
                </div>
            </div>
        </div>
        <button id="btnCreateCustom">Create Custom Listing</button>
        <div id="createMsg" class="small"></div>
    </div>

    <div class="section">
        <h2>My Listings</h2>
        <div class="small">Columns: Item / Price per stack & per ind / stk stock or demand / ind stock or demand / Status / Actions</div>
        <span id="listingsMsg" class="small"></span>
        <table>
            <thead>
                <tr>
                    <th>Item</th>
                    <th>Type</th>
                    <th>Prices</th>
                    <th>Stock / Demand</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="tbListings"></tbody>
        </table>
    </div>

    <div id="editPanel" class="section hidden">
        <h2>Edit Listing</h2>
        <div><b>ListingId:</b> <span id="editListingId"></span></div>
        <div><b>Item:</b> <span id="editItemName"></span></div>
        <div><b>Type:</b> <span id="editSide"></span></div>
        <div class="grid" style="margin-top:10px;">
            <div>
                <label>Stack Size: <input id="editStackSize" type="number" min="1"></label>
                <div class="stack-note">Changing stack size affects stack price display only.</div>
            </div>
            <div>
                <label>Quantity (ind): <input id="editQtyInd" type="number" min="1"></label>
                <div class="stack-note">Shows as stock (SELL) or demand (BUY).</div>
            </div>
            <div>
                <label>Price input: <input id="editPriceValue" type="number" min="0.0001" step="0.01"></label>
                <div class="radio-wrap">
                    <label><input type="radio" name="editPriceMode" id="editPriceModeInd" checked> ind price</label>
                    <label><input type="radio" name="editPriceMode" id="editPriceModeStack"> stk price</label>
                </div>
                <div class="small">Canonical stored: per-ind (4 decimals). UI shows 2 decimals.</div>
            </div>
            <div>
                <label>
                    Status:
                    <input type="checkbox" id="editStatusOpen"> Open
                </label>
            </div>
        </div>
        <div style="margin-top:10px;">
            <b>Derived:</b>
            <div>Per-ind price: <span id="editDerivedPriceInd" class="mono">0</span></div>
            <div>Per-stack price: <span id="editDerivedPriceStack" class="mono">0</span></div>
            <div>Stack count from quantity: <span id="editDerivedQtyStacks" class="mono">0</span></div>
        </div>
        <div style="margin-top:10px;">
            <button id="btnSaveEdit">Save Changes</button>
            <button id="btnCancelEdit" type="button">Cancel</button>
            <span id="editMsg" class="small"></span>
        </div>
    </div>

    <div class="footer-note">
        Internal storage uses individual price & quantity; stack data derived for display. SELL = stock, BUY = demand. Fee (5%) applied on SELL trade approval (seller receives 95%).
    </div>
</body>
</html>