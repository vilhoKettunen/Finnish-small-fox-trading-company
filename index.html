<!DOCTYPE html>
<html>
<head>
    <script src="auth-storage.js"></script>
    <meta charset="UTF-8">
    <title>Vak Store Trading Calculator</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 1100px;
            margin: auto;
        }

        h1, h2, h3 {
            color: #333;
        }

        .section {
            margin-bottom: 25px;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            position: relative;
            background: #fff;
        }

        select, input[type="number"], input[list], input[type="text"], button {
            padding: 6px;
            margin: 6px 0;
        }

        ul {
            margin-top: 10px;
            padding-left: 18px;
        }

        .result {
            margin-top: 10px;
            font-weight: bold;
        }

        .payRow {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

            .payRow input[type="number"] {
                width: 60px;
            }

        .negative {
            color: red;
        }

        .positive {
            color: green;
        }

        .more-info-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 0.8em;
            padding: 4px 8px;
            cursor: pointer;
        }

        .info-box {
            display: none;
            background: #f9f9f9;
            border: 1px solid #ccc;
            padding: 10px;
            margin-top: 10px;
            border-radius: 6px;
        }

        li .remove {
            margin-left: 8px;
            color: red;
            cursor: pointer;
        }

        .section ul li a {
            color: #0066cc;
            text-decoration: none;
        }

            .section ul li a:hover {
                text-decoration: underline;
            }

        #topBar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 52px;
            background: #222;
            color: #fff;
            display: flex;
            align-items: center;
            padding: 0 20px;
            z-index: 1000;
            font-size: 14px;
        }

            #topBar a, #topBar button {
                color: #fff;
                text-decoration: none;
                margin-right: 16px;
                background: none;
                border: none;
                cursor: pointer;
            }

            #topBar .right {
                margin-left: auto;
                display: flex;
                gap: 12px;
                align-items: center;
            }

        body.withTopBar {
            padding-top: 72px;
        }

        .dropdown-wrap {
            position: relative;
            display: inline-block;
        }

        .dropdown-input {
            width: 250px;
            padding: 6px;
        }

        .dropdown-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #fff;
            border: 1px solid #ccc;
            max-height: 220px;
            overflow-y: auto;
            z-index: 500;
            border-radius: 4px;
        }

        .dropdown-item {
            padding: 6px 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

            .dropdown-item:hover {
                background: #f0f6ff;
            }

            .dropdown-item.active {
                background: #dff0ff;
            }

        .stock-circle {
            width: 28px;
            height: 28px;
            flex: 0 0 auto;
        }

        .row-warning-yellow {
            background: #fff8d0;
        }

        .row-warning-red {
            background: #ffd6d6;
        }

        .small-note {
            font-size: 11px;
            color: #a00;
            margin-left: 8px;
        }

        .ocm-box {
            border: 1px dashed #999;
            padding: 10px;
            margin-top: 10px;
            border-radius: 6px;
            background: #fcfcfc;
        }

        .ocm-listing {
            font-size: 13px;
            margin: 2px 0;
            cursor: pointer;
        }

        .highlight-action {
            background: #e9f7ff;
        }

        .copy-btn {
            font-size: 12px;
            padding: 4px 6px;
        }

        #authPanel {
            margin-bottom: 20px;
        }

        #setupForm {
            display: none;
            margin-top: 10px;
        }

        #requestControls {
            margin-top: 20px;
        }

        @media (max-width:700px) {
            .dropdown-input {
                width: 180px;
            }
        }

        .login-hint {
            font-size: 12px;
            color: #555;
            margin-top: 4px;
        }

        .fallback-login {
            margin-top: 8px;
        }
        /* Status ball + popup */
        #orderStatusBall {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #777;
            cursor: pointer;
        }

        .status-pending {
            background: #f0c200 !important;
        }

        .status-error {
            background: #e74c3c !important;
        }

        .status-none {
            background: #777 !important;
        }

        .order-link {
            color: #66c;
            text-decoration: underline;
            cursor: pointer;
        }

        #orderPopup {
            position: absolute;
            top: 52px;
            right: 100px;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 8px;
            display: none;
            min-width: 260px;
            z-index: 1100;
        }
        /* Login button style */
        #btnLogin {
            padding: 6px 10px;
            background: #1a73e8;
            color: #fff;
            border: none;
            border-radius: 4px;
        }

        #btnLogout {
            padding: 6px 10px;
            background: #444;
            color: #fff;
            border: 1px solid #555;
            border-radius: 4px;
        }

        .guard-msg {
            font-size: 12px;
            color: #c00;
            margin-left: 8px;
        }

        /* Collapsible controls */
        .collapse-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            margin-left: 8px;
            background: none;
            border: 1px solid transparent;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
        }

            .collapse-btn:focus {
                outline: 2px solid #1a73e8;
            }

        .collapsible-header {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .collapsible-content {
            margin-top: 8px;
        }
        /* ===== Useful Links responsive button grid (paste into existing <style> block) ===== */
        .links-section { /* keeps section behavior consistent */
        }

        .links-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-top: 10px;
            align-items: stretch;
        }

        .link-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 12px 10px;
            background: #1a73e8;
            color: #fff;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            border: none;
            cursor: pointer;
            box-shadow: 0 1px 0 rgba(0,0,0,0.08);
            transition: transform .06s ease, box-shadow .06s ease, background .12s ease;
            min-height: 48px; /* comfortable tap target */
        }

            .link-btn:active {
                transform: translateY(1px);
            }

            .link-btn:hover {
                box-shadow: 0 4px 10px rgba(26,115,232,0.12);
                background: #155fc4;
            }

            .link-btn:focus {
                outline: 3px solid rgba(26,115,232,0.18);
            }

            /* internal links (local pages) use a neutral color */
            .link-btn.internal {
                background: #444;
            }

                .link-btn.internal:hover {
                    background: #333;
                }

        @media (max-width:420px) {
            .links-grid {
                gap: 8px;
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }

            .link-btn {
                padding: 14px 10px;
                font-size: 15px;
                min-height: 52px;
            }
        }
    </style>
    <script src="app-config.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
</head>
<body>
    <div id="topBar">
        <div><strong>Vak Store</strong></div>
        <button onclick="navigateStore()">Store</button>
        <button onclick="navigateHistory()">Account History</button>
        <button onclick="navigateOCM()">OCM</button>
        <button onclick="navigateMerchant()">OCM Merchant</button>
        <button id="adminPanelBtn" style="display:none;" onclick="navigateAdmin()">Admin Panel</button>
        <div class="right">
            <button id="btnLogin" onclick="startLogin()">Login</button>
            <div id="orderStatusBall" title="Orders status"></div>
            <div id="orderPopup">
                <div style="font-weight:bold;margin-bottom:6px;">Your open orders</div>
                <div id="orderPopupBody" class="small"></div>
            </div>
            <span id="topUser" class="small"></span>
            <button id="btnLogout" style="display:none;" onclick="logout()">Logout</button>
        </div>
    </div>

    <div id="authPanel">
        <div id="googleLoginArea">
            <div id="googleBtn"></div>
            <div class="login-hint">If the Google button does not appear, use fallback:</div>
            <div class="fallback-login">
                <button id="fallbackBtn" type="button" onclick="startFallbackLogin()">Fallback Google Login</button>
            </div>
            <div id="loginStatus" class="small"></div>
        </div>
        <div id="recaptchaContainer" style="margin-top:10px;"></div>
        <div id="setupForm">
            <h3>Account Setup</h3>
            <label>Player Name: <input type="text" id="setupPlayerName"></label><br>
            <label>Mailbox (e.g. 1A / 2B / F1): <input type="text" id="setupMailbox"></label><br>
            <button onclick="submitSetup()">Save Setup</button>
            <div id="setupMsg" class="small"></div>

            <div style="margin-top:12px;border-top:1px dashed #ccc;padding-top:10px;">
                <strong>Already have a store profile?</strong>
                <div class="small">Request access and an admin will confirm linking your Google account.</div>
                <input type="text" id="claimRefInput" placeholder="Your player name or mailbox or email">
                <button type="button" onclick="requestAccountClaim()">Request Access</button>
                <div id="claimMsg" class="small"></div>
            </div>
        </div>
    </div>

    <h1>üõí Vak Store Trading Calculator</h1>

    <!-- Display Currency -->
    <div class="section">
        <label for="currencyInput"><b>Display Currency:</b></label>
        <input id="currencyInput" list="currencyDatalist" placeholder="Search currency / item">
        <input id="currencySelect" type="hidden" value="BT">
        <datalist id="currencyDatalist"></datalist>
    </div>

    <!-- Quick calculators -->
    <div class="section">
        <h2>üîπ Quick Individual Item Calculator</h2>
        <button class="more-info-btn" onclick="toggleInfo('quickInfo')">More Info</button>
        <div id="quickInfo" class="info-box">
            <p>Quick calc for a stack or individual item. Pick item and qty to see buy & sell totals.</p>
            <button onclick="toggleInfo('quickInfo')">‚ùå Close</button>
        </div>
        <div>
            <label>Select Full Stack Item:</label>
            <div class="dropdown-wrap">
                <input id="quickStackSelect" class="dropdown-input" placeholder="Type to search stack item">
                <div id="quickStackSelectList" class="dropdown-list" style="display:none;"></div>
            </div>
            <input type="number" id="quickStackQty" value="1" min="1">
            <button onclick="quickStackCalc()">Calculate Stack</button>
            <div id="quickStackResult" class="result"></div>
        </div>
        <div>
            <label>Select Individual Item:</label>
            <div class="dropdown-wrap">
                <input id="quickIndivSelect" class="dropdown-input" placeholder="Type to search indiv item">
                <div id="quickIndivSelectList" class="dropdown-list" style="display:none;"></div>
            </div>
            <input type="number" id="quickIndivQty" value="1" min="1">
            <button onclick="quickIndivCalc()">Calculate Individual</button>
            <div id="quickIndivResult" class="result"></div>
        </div>
    </div>

    <!-- Buy Multiple Items -->
    <div class="section" id="buySection">
        <h2>üîπ Buy Multiple Items</h2>
        <button class="more-info-btn" onclick="toggleInfo('buyInfo')">More Info</button>
        <div id="buyInfo" class="info-box">
            <p>Add stacks/individuals you want to buy. Includes OCM listings if desired.</p>
            <button onclick="toggleInfo('buyInfo')">‚ùå Close</button>
        </div>
        <h3>Full Stacks (Store)</h3>
        <div class="dropdown-wrap">
            <input id="stackSelect" class="dropdown-input" placeholder="Search stack item">
            <div id="stackSelectList" class="dropdown-list" style="display:none;"></div>
        </div>
        <input type="number" id="stackQty" value="1" min="1">
        <button onclick="addStack()">Add Stack</button>

        <h3>Individual Items (Store)</h3>
        <div class="dropdown-wrap">
            <input id="indivSelect" class="dropdown-input" placeholder="Search individual item">
            <div id="indivSelectList" class="dropdown-list" style="display:none;"></div>
        </div>
        <input type="number" id="indivQty" value="1" min="1">
        <button onclick="addIndividual()">Add Individual</button>

        <div class="ocm-box">
            <div class="collapsible-header">
                <h3 style="margin:0">OCM Listings (Buy)</h3>
                <button id="toggleOCMBuy" class="collapse-btn" aria-expanded="false" onclick="toggleCollapse('ocmBuyContent','toggleOCMBuy')">‚ñ∏</button>
            </div>
            <div id="ocmBuyContent" class="collapsible-content" style="display:none">
                <input type="text" id="ocmBuyQuery" placeholder="Search OCM items">
                <button onclick="refreshOCMBuy()">Search</button>
                <div id="ocmBuyListings"></div>
                <label>Quantity: <input type="number" id="ocmBuyQty" value="1" min="1"></label>
                <button onclick="addOCMBuy()">Add OCM Item</button>
            </div>
        </div>

        <h3>Account Balance</h3>
        <label>Enter Balance (BT): <input type="number" id="buyAccountBalanceInput" value="0"></label>
        <button onclick="addBuyAccountBalance()">‚ûï Add Balance</button>

        <div class="section" style="padding:12px;margin-top:12px;">
            <div class="collapsible-header">
                <h3 style="margin:0">Custom Inputs (Store)</h3>
                <button id="toggleCustomBuy" class="collapse-btn" aria-expanded="false" onclick="toggleCollapse('customBuyContent','toggleCustomBuy')">‚ñ∏</button>
            </div>
            <div id="customBuyContent" class="collapsible-content" style="display:none">
                <div style="margin-top:8px">
                    <strong>From Spreadsheet ‚Äî Stack</strong><br>
                    <div class="dropdown-wrap">
                        <input id="customBuyStackSelect" class="dropdown-input" placeholder="Item name">
                        <div id="customBuyStackSelectList" class="dropdown-list" style="display:none;"></div>
                    </div>
                    <input type="number" id="customBuyStackQty" placeholder="Quantity" min="1">
                    <input type="number" id="customBuyStackPrice" placeholder="Price per Stack" step="0.01">
                    <button onclick="addCustomBuyStack()">Add Custom Stack</button>
                </div>
                <div style="margin-top:8px">
                    <strong>From Spreadsheet ‚Äî Individual</strong><br>
                    <div class="dropdown-wrap">
                        <input id="customBuyIndivSelect" class="dropdown-input" placeholder="Item name">
                        <div id="customBuyIndivSelectList" class="dropdown-list" style="display:none;"></div>
                    </div>
                    <input type="number" id="customBuyIndivQty" placeholder="Quantity" min="1">
                    <input type="number" id="customBuyIndivPrice" placeholder="Price per Each" step="0.01">
                    <button onclick="addCustomBuyIndividual()">Add Custom Individual</button>
                </div>
                <div style="margin-top:8px">
                    <strong>Fully Custom</strong><br>
                    <input type="text" id="customBuyName" placeholder="Name">
                    <input type="number" id="customBuyQty" placeholder="Quantity (pieces)" min="1">
                    <input type="number" id="customBuyStackSize" placeholder="Stack size" min="1">
                    <input type="number" id="customBuyPrice" placeholder="Price per Stack" step="0.01">
                    <button onclick="addFullyCustomBuy()">Add Fully Custom</button>
                </div>
            </div>
        </div>

        <ul id="buyList"></ul>
        <div id="buyTotalBox" class="negative">Buy Total: <span id="buyTotal">0.00</span></div>
    </div>

    <!-- Sell Multiple Items -->
    <div class="section" id="sellSection">
        <h2>üîπ Sell Multiple Items</h2>
        <button class="more-info-btn" onclick="toggleInfo('sellInfo')">More Info</button>
        <div id="sellInfo" class="info-box">
            <p>Add items you sell. Includes OCM interaction and Pay With.</p>
            <button onclick="toggleInfo('sellInfo')">‚ùå Close</button>
        </div>
        <h3>Full Stacks (Store)</h3>
        <div class="dropdown-wrap">
            <input id="sellStackSelect" class="dropdown-input" placeholder="Search stack item">
            <div id="sellStackSelectList" class="dropdown-list" style="display:none;"></div>
        </div>
        <input type="number" id="sellStackQty" value="1" min="1">
        <button onclick="addSellStack()">Add Stack</button>

        <h3>Individual Items (Store)</h3>
        <div class="dropdown-wrap">
            <input id="sellIndivSelect" class="dropdown-input" placeholder="Search individual item">
            <div id="sellIndivSelectList" class="dropdown-list" style="display:none;"></div>
        </div>
        <input type="number" id="sellIndivQty" value="1" min="1">
        <button onclick="addSellIndividual()">Add Individual</button>

        <div class="ocm-box">
            <div class="collapsible-header">
                <h3 style="margin:0">OCM Listings (Sell)</h3>
                <button id="toggleOCMSell" class="collapse-btn" aria-expanded="false" onclick="toggleCollapse('ocmSellContent','toggleOCMSell')">‚ñ∏</button>
            </div>
            <div id="ocmSellContent" class="collapsible-content" style="display:none">
                <input type="text" id="ocmSellQuery" placeholder="Search OCM items">
                <button onclick="refreshOCMSell()">Search</button>
                <div id="ocmSellListings"></div>
                <label>Quantity: <input type="number" id="ocmSellQty" value="1" min="1"></label>
                <button onclick="addOCMSell()">Add OCM Item</button>
            </div>
        </div>

        <h3>Account Balance</h3>
        <label>Enter Balance (BT): <input type="number" id="accountBalanceInput" value="0"></label>
        <button onclick="addAccountBalance()">‚ûï Add Balance</button>

        <div class="section" style="padding:12px;margin-top:12px;">
            <div class="collapsible-header">
                <h3 style="margin:0">Custom Inputs (Sell)</h3>
                <button id="toggleCustomSell" class="collapse-btn" aria-expanded="false" onclick="toggleCollapse('customSellContent','toggleCustomSell')">‚ñ∏</button>
            </div>
            <div id="customSellContent" class="collapsible-content" style="display:none">
                <div style="margin-top:8px">
                    <strong>From Spreadsheet ‚Äî Stack</strong><br>
                    <div class="dropdown-wrap">
                        <input id="customSellStackSelect" class="dropdown-input" placeholder="Item name">
                        <div id="customSellStackSelectList" class="dropdown-list" style="display:none;"></div>
                    </div>
                    <input type="number" id="customSellStackQty" placeholder="Quantity" min="1">
                    <input type="number" id="customSellStackPrice" placeholder="Price per Stack" step="0.01">
                    <button onclick="addCustomSellStack()">Add Custom Stack</button>
                </div>
                <div style="margin-top:8px">
                    <strong>From Spreadsheet ‚Äî Individual</strong><br>
                    <div class="dropdown-wrap">
                        <input id="customSellIndivSelect" class="dropdown-input" placeholder="Item name">
                        <div id="customSellIndivSelectList" class="dropdown-list" style="display:none;"></div>
                    </div>
                    <input type="number" id="customSellIndivQty" placeholder="Quantity" min="1">
                    <input type="number" id="customSellIndivPrice" placeholder="Price per Each" step="0.01">
                    <button onclick="addCustomSellIndividual()">Add Custom Individual</button>
                </div>
                <div style="margin-top:8px">
                    <strong>Fully Custom</strong><br>
                    <input type="text" id="customSellName" placeholder="Name">
                    <input type="number" id="customSellQty" placeholder="Quantity (pieces)" min="1">
                    <input type="number" id="customSellStackSize" placeholder="Stack size" min="1">
                    <input type="number" id="customSellPrice" placeholder="Price per Stack" step="0.01">
                    <button onclick="addFullyCustomSell()">Add Fully Custom</button>
                </div>
            </div>
        </div>

        <ul id="sellList"></ul>
        <div id="sellTotalBox" class="positive">Sell Total: <span id="sellTotal">0.00</span></div>
    </div>

    <!-- Combined Totals -->
    <div class="section">
        <h2>üîπ Combined Totals</h2>
        <button class="more-info-btn" onclick="toggleInfo('combinedInfo')">More Info</button>
        <div id="combinedInfo" class="info-box">
            <p>Net Balance: sell - buy.</p>
            <button onclick="toggleInfo('combinedInfo')">‚ùå Close</button>
        </div>
        <div id="combinedTotalBox">Net Balance: <span id="netTotal">0.00</span></div>
    </div>

    <!-- Pay With -->
    <div class="section">
        <h2>üîπ Pay With</h2>
        <button class="more-info-btn" onclick="toggleInfo('payInfo')">More Info</button>
        <div id="payInfo" class="info-box">
            <p>Cover a negative net with item payments.</p>
            <button onclick="toggleInfo('payInfo')">‚ùå Close</button>
        </div>
        <div id="payOptions"></div>
        <button onclick="addPayRow()">‚ûï Add Item</button>
        <ul id="payList"></ul>
        <button onclick="calculatePayment()">Calculate Payment</button>
        <div id="paymentResult" class="result"></div>
    </div>

    <!-- Item Converter -->
    <div class="section">
        <h2>üîπ Item Converter</h2>
        <button class="more-info-btn" onclick="toggleInfo('converterInfo')">More Info</button>
        <div id="converterInfo" class="info-box">
            <p>Allocate % of positive Net Balance into items.</p>
            <button onclick="toggleInfo('converterInfo')">‚ùå Close</button>
        </div>
        <div id="converterOptions"></div>
        <button onclick="addConverterRow()">‚ûï Add Item</button>
        <ul id="converterListDisplay"></ul>
        <button onclick="calculateConversion()">Convert Balance</button>
        <div id="converterResult" class="result"></div>
    </div>

    <!-- Request Controls -->
    <div id="requestControls" class="section">
        <h2>üîπ Transaction Request</h2>
        <div id="requestGuard" class="guard-msg" style="display:none;">You need to login for this tool.</div>
        <button onclick="guardedSubmitPurchaseRequest()">Submit Purchase Request</button>
        <button class="copy-btn" onclick="guardedCopyTransactionData()">Copy Transaction Data</button>
        <!-- Add inside <div id="requestControls" class="section"> ... -->
        <button class="copy-btn" onclick="importTransactionData()">Import Transaction Data</button>
        <input id="importFile" type="file" accept="application/json" style="display:none" onchange="importTransactionDataFromFile(this.files[0])">
        <div id="requestMsg" class="small"></div>
    </div>

    <!-- Admin: Submit on behalf of (Admin only) -->
    <div id="onBehalfSection" class="section" style="display:none;">
        <h2>üë§ Submit on behalf of (Admin)</h2>
        <div class="small">Search a player and set them as the target for the next submission. The request will be recorded in their history.</div>
        <div class="dropdown-wrap" style="margin-top:6px;">
            <input id="obPlayerSearchInput" class="dropdown-input" placeholder="Type player name or email">
            <div id="obPlayerSearchList" class="dropdown-list" style="display:none;"></div>
        </div>
        <button id="btnSetOnBehalf" type="button" onclick="setOnBehalfTarget()">Set as target</button>
        <button id="btnClearOnBehalf" type="button" onclick="clearOnBehalfTarget()">Clear</button>
        <div id="onBehalfStatus" class="small"></div>
    </div>

    <!-- Links -->
    <div class="section links-section" id="usefulLinks">
        <h2>üîó Useful Links</h2>
        <nav class="links-grid" aria-label="Useful links">
            <a class="link-btn" href="https://translocator.moe/" target="_blank" rel="noopener">TL route calculator</a>
            <a class="link-btn" href="https://map.tops.vintagestory.at/?x=-419&y=416&zoom=6" target="_blank" rel="noopener">TOPS map</a>
            <a class="link-btn" href="https://wiki.vintagestory.at/Main_Page" target="_blank" rel="noopener">Wiki</a>
            <a class="link-btn" href="https://docs.google.com/spreadsheets/d/1W9ByTiwX3lPakqoYXTHgnOiMNNzwSVnkgmTPqvMrSUc/edit?gid=0#gid=0" target="_blank" rel="noopener">Mailbox names</a>
            <a class="link-btn" href="https://docs.google.com/spreadsheets/d/1_meliJtuKSDwEWRDh1gldcsD-pSjDgIND3dcE1mCjCo/edit?gid=0#gid=0" target="_blank" rel="noopener">PRICE SHEET</a>
            <a class="link-btn" href="https://www.vintagestory.at/" target="_blank" rel="noopener">Vintage Story</a>
            <a class="link-btn" href="https://mods.vintagestory.at/" target="_blank" rel="noopener">Official mods</a>
            <a class="link-btn internal" href="BTIncurance.html" target="_blank" rel="noopener">BT Insurance</a>
            <a class="link-btn internal" href="PriceHistory.html" target="_blank" rel="noopener">Price History</a>
            <a class="link-btn internal" href="VintageStoryEconomics.html" target="_blank" rel="noopener">Vintage Story Economics</a>
        </nav>
    </div>

    <script>
        /* ===== CONFIG / CONSTANTS ===== */
        const WEB_APP_URL = window.WEB_APP_URL || 'https://yellow-king-52c6.vilhokettu1.workers.dev/exec';
        const RECAPTCHA_SITE_KEY = window.RECAPTCHA_SITE_KEY || '6LdjcAgsAAAAABWoHl5dmFjbJQL61kOu7ddvkUZF';
        const OAUTH_CLIENT_ID = window.OAUTH_CLIENT_ID || '857098772457-kuvq861sa844esf2jc4b7av1pnlmnn1c.apps.googleusercontent.com';
        const sheetURL = "https://docs.google.com/spreadsheets/d/1_meliJtuKSDwEWRDh1gldcsD-pSjDgIND3dcE1mCjCo/gviz/tq?tqx=out:json&gid=0";
        const BASE_CURRENCY = "BT";

        let items = [], payItems = [], buyCart = [], sellCart = [];
        let stockProgressCache = [];
        let dropdownData = [];
        let currentUser = null;
        let googleIdToken = null;
        let recaptchaWidgetId = null;
        let lastRecaptchaToken = null;
        let ocmListingsCacheBuy = [], ocmListingsCacheSell = [];
        window.editedFromRequestId = null;
        // Admin: on-behalf submission
        window.submitForUser = null;
        const __playersCache = []; // list of players for admin on-behalf search

        /* ===== Collapsible helpers ===== */
        function setCollapseState(btnId, open) {
            try { localStorage.setItem('__collapse__' + btnId, open ? 'open' : 'closed'); } catch (_) { }
        }
        function getCollapseState(btnId) {
            try { return localStorage.getItem('__collapse__' + btnId) === 'open'; } catch (_) { return false; }
        }
        function applyCollapseState(contentId, btnId, open) {
            const content = document.getElementById(contentId);
            const btn = document.getElementById(btnId);
            if (!content || !btn) return;
            if (open) {
                content.style.display = 'block';
                btn.textContent = '‚ñæ';
                btn.setAttribute('aria-expanded', 'true');
            } else {
                content.style.display = 'none';
                btn.textContent = '‚ñ∏';
                btn.setAttribute('aria-expanded', 'false');
            }
        }
        function toggleCollapse(contentId, btnId) {
            const cur = getComputedStyle(document.getElementById(contentId)).display !== 'none';
            applyCollapseState(contentId, btnId, !cur);
            setCollapseState(btnId, !cur);
        }
        function initCollapsibles() {
            const mapping = [
                { content: 'ocmBuyContent', btn: 'toggleOCMBuy' },
                { content: 'customBuyContent', btn: 'toggleCustomBuy' },
                { content: 'ocmSellContent', btn: 'toggleOCMSell' },
                { content: 'customSellContent', btn: 'toggleCustomSell' }
            ];
            mapping.forEach(m => {
                const savedOpen = getCollapseState(m.btn);
                applyCollapseState(m.content, m.btn, !!savedOpen);
            });
        }

        /* ===== Navigation gating ===== */
        function navigateStore() { scrollIntoViewSmooth('buySection'); }
        function navigateHistory() {
            if (!googleIdToken) { alert('You need to login for this tool'); return; }
            window.location.href = 'AccountHistory.html';
        }
        function navigateOCM() { window.location.href = 'OCMHome.html'; }
        function navigateMerchant() {
            if (!googleIdToken) { alert('You need to login for this tool'); return; }
            window.location.href = 'OCMUser.html';
        }
        function navigateAdmin() {
            if (!googleIdToken || !currentUser?.isAdmin) { alert('Admin only'); return; }
            window.location.href = 'Admin.html';
        }

        function scrollIntoViewSmooth(id) {
            const el = document.getElementById(id);
            if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        /* ===== Google Identity ===== */
        function initGoogleIdentity() {
            if (!window.google || !google.accounts || !google.accounts.id) return;
            google.accounts.id.initialize({
                client_id: OAUTH_CLIENT_ID,
                callback: handleCredentialResponse,
                ux_mode: 'popup',
                auto_select: false,
                use_fedcm_for_prompt: false
            });
            google.accounts.id.renderButton(
                document.getElementById('googleBtn'),
                { theme: 'outline', size: 'large', type: 'standard', shape: 'rectangular', logo_alignment: 'left' }
            );
        }
        function handleCredentialResponse(resp) { onGoogleSignIn(resp); }

        function startFallbackLogin() {
            const nonce = cryptoRandomId();
            const redirectUri = location.origin + location.pathname;
            const authUrl =
                'https://accounts.google.com/o/oauth2/v2/auth' +
                '?client_id=' + encodeURIComponent(OAUTH_CLIENT_ID) +
                '&redirect_uri=' + encodeURIComponent(redirectUri) +
                '&response_type=id_token' +
                '&scope=' + encodeURIComponent('openid email profile') +
                '&nonce=' + encodeURIComponent(nonce) +
                '&prompt=select_account';
            window.location.href = authUrl;
        }

        function startLogin() {
            if (window.google && google.accounts && google.accounts.id) {
                try { google.accounts.id.prompt(); } catch { startFallbackLogin(); }
            } else {
                startFallbackLogin();
            }
        }

        function checkHashForIdToken() {
            if (location.hash) {
                const params = new URLSearchParams(location.hash.slice(1));
                const idt = params.get('id_token');
                if (idt) {
                    handleCredentialResponse({ credential: idt });
                    history.replaceState({}, document.title, location.pathname + location.search);
                }
            }
        }

        function normalizeUser(u) {
            if (!u) return u;
            const candidate =
                (u.playerName && String(u.playerName).trim()) ||
                (u.player && String(u.player).trim()) ||
                (u.name && String(u.name).trim()) ||
                (u.displayName && String(u.displayName).trim()) ||
                null;
            u.playerName = candidate || null;
            return u;
        }

        async function onGoogleSignIn(resp) {
            const statusEl = document.getElementById('loginStatus');
            googleIdToken = resp && resp.credential;
            if (!googleIdToken) { statusEl.textContent = 'Login error: no credential'; return; }
            statusEl.textContent = 'Verifying token...';
            try {
                const tResp = await fetch(`https://oauth2.googleapis.com/tokeninfo?id_token=${encodeURIComponent(googleIdToken)}`);
                if (!tResp.ok) throw new Error('tokeninfo failed ' + tResp.status);
                const info = await tResp.json();
                if (info.aud !== OAUTH_CLIENT_ID) throw new Error('Invalid audience');

                window.saveIdToken && window.saveIdToken(googleIdToken);

                statusEl.textContent = 'Loading profile...';
                const meResp = await fetch(`${WEB_APP_URL}?action=me&idToken=${encodeURIComponent(googleIdToken)}`);
                const meJson = await meResp.json();
                if (!meJson.ok) throw new Error(meJson.error || 'Backend error');

                const serverUser = normalizeUser(meJson.data.user || null);
                currentUser = serverUser;
                currentUser.isAdmin = !!meJson.data.isAdmin;

                updateTopBarAuth();
                document.getElementById('adminPanelBtn').style.display = currentUser.isAdmin ? 'inline' : 'none';
                document.getElementById('onBehalfSection').style.display = currentUser.isAdmin ? 'block' : 'none';

                if (currentUser.isAdmin) {
                    try { await adminLoadPlayers(); } catch { /* ignore */ }
                }

                const hasSetup = serverUser && serverUser.playerName;
                const passedCaptcha = serverUser && serverUser.captchaPassed;

                if (hasSetup && passedCaptcha) {
                    localStorage.setItem('vak_captcha_ok', '1');
                    hideRecaptchaWidget();
                    hideSetupShowApp();
                } else {
                    localStorage.removeItem('vak_captcha_ok');
                    showSetupOnly();
                    showRecaptchaWidget();
                }

                // Auto-import balance for active target
                try { await refreshPinnedBalanceForActiveTarget(); } catch (_) { /* non-fatal */ }

                statusEl.textContent = 'Logged in.';
                refreshOpenOrders();
            } catch (e) {
                statusEl.textContent = 'Login error: ' + e.message;
            }
        }

        function updateTopBarAuth() {
            document.getElementById('topUser').textContent = googleIdToken ? (currentUser?.email || '') : '';
            document.getElementById('btnLogin').style.display = googleIdToken ? 'none' : 'inline-block';
            document.getElementById('btnLogout').style.display = googleIdToken ? 'inline-block' : 'none';
        }

        /* ===== reCAPTCHA ===== */
        function showRecaptchaWidget() { const c = document.getElementById('recaptchaContainer'); if (c) c.style.display = 'block'; }
        function hideRecaptchaWidget() { const c = document.getElementById('recaptchaContainer'); if (c) c.style.display = 'none'; }

        function initRecaptcha() {
            if (localStorage.getItem('vak_captcha_ok') === '1') {
                const c = document.getElementById('recaptchaContainer');
                if (c) c.style.display = 'none';
                lastRecaptchaToken = null;
                return;
            }
            const tryRender = () => {
                if (window.grecaptcha && recaptchaWidgetId === null) {
                    recaptchaWidgetId = grecaptcha.render('recaptchaContainer', {
                        sitekey: RECAPTCHA_SITE_KEY,
                        callback: t => { lastRecaptchaToken = t; },
                        'expired-callback': () => { lastRecaptchaToken = null; }
                    });
                }
            };
            if (window.grecaptcha) tryRender();
            else {
                let tries = 0;
                const iv = setInterval(() => {
                    tries++;
                    if (window.grecaptcha) { tryRender(); clearInterval(iv); }
                    if (tries > 20) clearInterval(iv);
                }, 250);
            }
        }

        function recaptchaWrap() {
            return new Promise((resolve, reject) => {
                if (localStorage.getItem('vak_captcha_ok') === '1') return resolve(null);
                if (lastRecaptchaToken) return resolve(lastRecaptchaToken);
                if (window.grecaptcha) {
                    document.getElementById('recaptchaContainer').scrollIntoView({ behavior: 'smooth', block: 'center' });
                    return reject(new Error('Complete reCAPTCHA checkbox first.'));
                }
                reject(new Error('reCAPTCHA not loaded yet.'));
            });
        }

        /* ===== Setup gating ===== */
        function showSetupOnly() {
            const setup = document.getElementById('setupForm');
            const req = document.getElementById('requestControls');
            if (setup) setup.style.display = 'block';
            if (req) req.style.display = 'block'; // still visible, but guarded
            showRecaptchaWidget();
            document.getElementById('requestGuard').style.display = googleIdToken ? 'none' : 'block';
        }
        function hideSetupShowApp() {
            const setup = document.getElementById('setupForm');
            if (setup) setup.style.display = 'none';
            hideRecaptchaWidget();
            document.getElementById('requestGuard').style.display = 'none';
        }

        async function submitSetup() {
            const playerName = document.getElementById('setupPlayerName').value.trim();
            const mailbox = document.getElementById('setupMailbox').value.trim();
            const statusEl = document.getElementById('setupMsg');

            if (!googleIdToken) { statusEl.textContent = 'Login first'; return; }
            if (!playerName || !mailbox) { statusEl.textContent = 'Player name and mailbox required'; return; }

            const needCaptcha = !localStorage.getItem('vak_captcha_ok');
            let recaptchaToken = null;
            if (needCaptcha) {
                try { recaptchaToken = await recaptchaWrap(); } catch (e) { statusEl.textContent = e.message; return; }
            }

            statusEl.textContent = 'Saving...';

            try {
                const body = {
                    action: 'linkPlayer',
                    idToken: googleIdToken,
                    payload: { playerName, mailbox }
                };
                if (recaptchaToken) body.recaptchaToken = recaptchaToken;

                const resp = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const j = await resp.json();
                if (!j.ok) throw new Error(j.error || 'linkPlayer failed');

                const meResp = await fetch(`${WEB_APP_URL}?action=me&idToken=${encodeURIComponent(googleIdToken)}`);
                const meJson = await meResp.json();
                if (!meJson.ok) throw new Error(meJson.error || 'me failed');
                currentUser = normalizeUser(meJson.data.user || null);
                currentUser.isAdmin = !!meJson.data.isAdmin;

                if (currentUser.playerName && currentUser.captchaPassed) {
                    localStorage.setItem('vak_captcha_ok', '1');
                    hideSetupShowApp();
                } else {
                    localStorage.removeItem('vak_captcha_ok');
                    showSetupOnly();
                }
                updateTopBarAuth();
                statusEl.textContent = 'Setup complete.';

                // refresh balance for current user
                try { await refreshPinnedBalanceForActiveTarget(); } catch { }
            } catch (e) {
                statusEl.textContent = 'Error: ' + e.message;
            }
        }

        // Request access to an existing profile (claim flow)
        async function requestAccountClaim() {
            const msg = document.getElementById('claimMsg');
            msg.textContent = '';
            if (!googleIdToken) { msg.textContent = 'Login first.'; return; }
            const ref = (document.getElementById('claimRefInput').value || '').trim();
            if (!ref) { msg.textContent = 'Enter player name, mailbox or email.'; return; }
            try {
                const r = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'requestAccountClaim', idToken: googleIdToken, payload: { targetRef: ref } })
                });
                const j = await r.json();
                if (!j.ok) throw new Error(j.error || 'requestAccountClaim failed');
                msg.textContent = 'Request sent. An admin will review it.';
            } catch (e) {
                msg.textContent = 'Error: ' + e.message;
            }
        }

        /* ===== Logout ===== */
        function logout() {
            googleIdToken = null;
            currentUser = null;
            isAdmin = false;
            window.submitForUser = null;
            // remove pinned balance from receipt
            sellCart = sellCart.filter(e => !e.isAccountBalancePinned);
            window.clearSavedIdToken && window.clearSavedIdToken();
            document.getElementById('loginStatus').textContent = 'Logged out.';
            document.getElementById('adminPanelBtn').style.display = 'none';
            document.getElementById('onBehalfSection').style.display = 'none';
            updateTopBarAuth();
            document.getElementById('requestGuard').style.display = 'block';
            const st = document.getElementById('onBehalfStatus'); if (st) st.textContent = '';
            renderSellList(); calculateNet();
        }

        /* ===== Data loading ===== */
        function loadData() {
            fetch(sheetURL)
                .then(r => { if (!r.ok) throw new Error(r.status); return r.text(); })
                .then(txt => {
                    let payloadText = txt;
                    const start = payloadText.indexOf('('), end = payloadText.lastIndexOf(')');
                    if (start > -1 && end > start) payloadText = payloadText.slice(start + 1, end);
                    const json = JSON.parse(payloadText);
                    const rows = json?.table?.rows || [];
                    items = rows.map(row => {
                        const c = row.c || [];
                        const name = c[0]?.v ?? "";
                        const buyStack = c[1]?.v ?? "";
                        const sellStack = c[2]?.v ?? "";
                        const stackStock = Number(c[3]?.v ?? 0);
                        const bundleSize = Number(c[4]?.v ?? 1);
                        const buyEach = c[5]?.v ?? "";
                        const sellEach = c[6]?.v ?? "";
                        const indivStock = Number(c[7]?.v ?? 0);
                        const availPercent = Number(c[8]?.v ?? 0);
                        const targetEach = Number(c[9]?.v ?? 0);
                        if (!name) return null;
                        if ((buyStack === "X" && sellStack === "X") && (buyEach === "X" && sellEach === "X")) return null;
                        const parseNumOrNull = v => {
                            if (v === null || v === "" || v === undefined) return null;
                            const n = Number(v); return isNaN(n) ? null : n;
                        };
                        return {
                            name: String(name),
                            bundleSize: bundleSize || 1,
                            stackStock, indivStock, availPercent, targetEach: targetEach || 0,
                            buyStack: parseNumOrNull(buyStack),
                            sellStack: parseNumOrNull(sellStack),
                            buyEach: parseNumOrNull(buyEach),
                            sellEach: parseNumOrNull(sellEach)
                        };
                    }).filter(Boolean);

                    stockProgressCache = items.map(i => {
                        const bs = Number(i.bundleSize || 1) || 1;
                        const currentStacks = (Number(i.indivStock || 0) / bs);
                        const targetStacks = Number(i.targetEach || 0);
                        return { name: i.name, currentStacks, targetStacks };
                    });

                    payItems = items.slice();
                    populateCurrencyDatalist();
                    setupDropdowns();
                })
                .catch(err => {
                    console.error('Failed to load sheet:', err);
                    items = []; payItems = []; stockProgressCache = [];
                    populateCurrencyDatalist(); setupDropdowns();
                });
        }

        function populateCurrencyDatalist() {
            const currencyDatalist = document.getElementById("currencyDatalist");
            currencyDatalist.innerHTML = "";
            currencyDatalist.appendChild(new Option(BASE_CURRENCY, BASE_CURRENCY));
            items.forEach(i => {
                currencyDatalist.appendChild(new Option(`${i.name} ‚Äî stack:${i.stackStock} each:${i.indivStock} avail:${i.availPercent}%`, i.name));
            });
            const input = document.getElementById("currencyInput");
            const hidden = document.getElementById("currencySelect");
            input.onchange = () => {
                const val = input.value.trim();
                const exact = items.find(it => it.name.toLowerCase() === val.toLowerCase());
                hidden.value = exact ? exact.name : BASE_CURRENCY;
                updateAllDisplays();
            };
            input.oninput = () => {
                const v = input.value.trim();
                const exact = items.find(it => it.name.toLowerCase() === v.toLowerCase());
                if (exact) { hidden.value = exact.name; updateAllDisplays(); }
            };
        }

        function setupDropdowns() {
            dropdownData = items.map(i => ({ name: i.name, extra: `stk:${i.stackStock} each:${i.indivStock} avail:${i.availPercent}%` }));
            function filterBy(q) { if (!q) return dropdownData.slice(0, 200); return dropdownData.filter(d => d.name.toLowerCase().includes(q)); }
            ['quickStackSelect', 'quickIndivSelect', 'stackSelect', 'indivSelect', 'sellStackSelect', 'sellIndivSelect',
                'customBuyStackSelect', 'customBuyIndivSelect', 'customSellStackSelect', 'customSellIndivSelect']
                .forEach(id => attachDropdown(id, id + 'List', filterBy, () => { }));
        }

        function attachDropdown(inputId, listId, filterFn, selectCallback) {
            const input = document.getElementById(inputId);
            const list = document.getElementById(listId);
            if (!input || !list) return;
            function setActiveIndex(idx) {
                const itemsEls = Array.from(list.querySelectorAll('.dropdown-item'));
                itemsEls.forEach(it => it.classList.remove('active'));
                if (idx >= 0 && idx < itemsEls.length) {
                    itemsEls[idx].classList.add('active');
                    itemsEls[idx].scrollIntoView({ block: 'nearest' });
                    input._dropIndex = idx;
                } else input._dropIndex = -1;
            }
            function renderAndShow() {
                const q = (input.value || "").toLowerCase();
                const filtered = filterFn(q);
                renderDropdownList(list, filtered, (val) => {
                    input.value = val; list.style.display = 'none'; input._dropIndex = -1;
                    if (selectCallback) selectCallback(val);
                });
                input._dropIndex = -1;
                list.style.display = list.querySelectorAll('.dropdown-item').length ? 'block' : 'none';
            }
            input.addEventListener('input', renderAndShow);
            input.addEventListener('focus', renderAndShow);
            input.addEventListener('keydown', ev => {
                const itemsEls = Array.from(list.querySelectorAll('.dropdown-item'));
                if (!itemsEls.length) return;
                if (ev.key === 'ArrowDown') { ev.preventDefault(); setActiveIndex(Math.min((input._dropIndex || -1) + 1, itemsEls.length - 1)); }
                else if (ev.key === 'ArrowUp') { ev.preventDefault(); setActiveIndex(Math.max((input._dropIndex || -1) - 1, 0)); }
                else if (ev.key === 'Enter') {
                    if (typeof input._dropIndex === 'number' && input._dropIndex >= 0) { ev.preventDefault(); itemsEls[input._dropIndex].click(); }
                } else if (ev.key === 'Escape') { list.style.display = 'none'; input._dropIndex = -1; }
            });
            input.addEventListener('blur', () => setTimeout(() => { list.style.display = 'none'; input._dropIndex = -1; }, 200));
        }

        function renderDropdownList(container, arr, onSelect) {
            container.innerHTML = '';
            arr.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'dropdown-item';
                div.dataset.index = String(idx);
                let pct = 0;
                const prog = stockProgressCache.find(sp => sp.name === item.name);
                const itemObj = items.find(it => it.name === item.name);
                if (prog && itemObj) {
                    const target = Number(itemObj.targetEach || 0);
                    if (target > 0) pct = Math.round((prog.currentStacks / target) * 100);
                }
                pct = Math.max(0, Math.min(100, pct));
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                circle.setAttribute('class', 'stock-circle'); circle.setAttribute('viewBox', '0 0 36 36');
                const bg = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                bg.setAttribute('cx', '18'); bg.setAttribute('cy', '18'); bg.setAttribute('r', '16');
                bg.setAttribute('stroke', '#eee'); bg.setAttribute('stroke-width', '4'); bg.setAttribute('fill', 'none');
                const fg = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                fg.setAttribute('cx', '18'); fg.setAttribute('cy', '18'); fg.setAttribute('r', '16');
                fg.setAttribute('stroke', pct >= 100 ? '#3cb371' : '#2196f3');
                fg.setAttribute('stroke-width', '4'); fg.setAttribute('fill', 'none');
                fg.setAttribute('stroke-dasharray', Math.round((pct / 100) * 2 * Math.PI * 16) + ',1000');
                fg.setAttribute('transform', 'rotate(-90 18 18)');
                circle.appendChild(bg); circle.appendChild(fg);
                const label = document.createElement('div');
                label.innerHTML = `<strong>${item.name}</strong><br><small>${item.extra}</small>`;
                div.appendChild(circle); div.appendChild(label);
                div.addEventListener('mouseover', () => {
                    Array.from(container.querySelectorAll('.dropdown-item')).forEach(s => s.classList.remove('active'));
                    div.classList.add('active');
                });
                div.onclick = () => onSelect(item.name);
                container.appendChild(div);
            });
        }

        /* ===== Quick Calcs ===== */
        function quickStackCalc() {
            const name = document.getElementById("quickStackSelect").value;
            const qty = parseInt(document.getElementById("quickStackQty").value) || 0;
            const item = items.find(i => i.name === name); if (!item) return;
            const buyText = item.buyStack ? `${qty} √ó ${item.bundleSize} ${item.name} buys for ${(qty * item.buyStack).toFixed(2)} BT` : "";
            const sellText = item.sellStack ? `${qty} √ó ${item.bundleSize} ${item.name} sells for ${(qty * item.sellStack).toFixed(2)} BT` : "";
            document.getElementById("quickStackResult").textContent = [buyText, sellText].filter(Boolean).join(" | ");
        }
        function quickIndivCalc() {
            const name = document.getElementById("quickIndivSelect").value;
            const qty = parseInt(document.getElementById("quickIndivQty").value) || 0;
            const item = items.find(i => i.name === name); if (!item) return;
            const buyText = item.buyEach ? `${qty} √ó ${item.name} buys for ${(qty * item.buyEach).toFixed(2)} BT` : "";
            const sellText = item.sellEach ? `${qty} √ó ${item.name} sells for ${(qty * item.sellEach).toFixed(2)} BT` : "";
            document.getElementById("quickIndivResult").textContent = [buyText, sellText].filter(Boolean).join(" | ");
        }

        /* ===== Add Items (Buy/Sell) ===== */
        function addStack() {
            const name = document.getElementById("stackSelect").value;
            const qty = parseInt(document.getElementById("stackQty").value) || 0;
            const item = items.find(i => i.name === name); if (!item || !item.sellStack) return;
            buyCart.push({ name: item.name, qty, price: item.sellStack, bundleSize: item.bundleSize, source: 'STORE' }); renderBuyList();
        }
        function addIndividual() {
            const name = document.getElementById("indivSelect").value;
            const qty = parseInt(document.getElementById("indivQty").value) || 0;
            const item = items.find(i => i.name === name); if (!item || !item.sellEach) return;
            buyCart.push({ name: item.name, qty, price: item.sellEach, source: 'STORE' }); renderBuyList();
        }
        function addBuyAccountBalance() {
            const balance = parseFloat(document.getElementById("buyAccountBalanceInput").value) || 0;
            if (balance <= 0) return;
            buyCart.push({ name: "Account Balance", qty: 1, price: balance, isBalance: true, source: 'BALANCE' }); renderBuyList();
        }
        function addCustomBuyStack() {
            const name = document.getElementById("customBuyStackSelect").value;
            const qty = parseInt(document.getElementById("customBuyStackQty").value) || 0;
            const price = parseFloat(document.getElementById("customBuyStackPrice").value) || 0;
            const item = items.find(i => i.name === name);
            if (!item || qty <= 0 || price <= 0) return;
            buyCart.push({ name: item.name, qty, price, bundleSize: item.bundleSize, isCustom: true, source: 'STORE' }); renderBuyList();
        }
        function addCustomBuyIndividual() {
            const name = document.getElementById("customBuyIndivSelect").value;
            const qty = parseInt(document.getElementById("customBuyIndivQty").value) || 0;
            const price = parseFloat(document.getElementById("customBuyIndivPrice").value) || 0;
            const item = items.find(i => i.name === name);
            if (!item || qty <= 0 || price <= 0) return;
            buyCart.push({ name: item.name, qty, price, isCustom: true, source: 'STORE' }); renderBuyList();
        }
        function addFullyCustomBuy() {
            const name = document.getElementById("customBuyName").value.trim();
            const qty = parseInt(document.getElementById("customBuyQty").value) || 0;
            const stackSize = parseInt(document.getElementById("customBuyStackSize").value) || 1;
            const price = parseFloat(document.getElementById("customBuyPrice").value) || 0;
            if (!name || qty <= 0 || price <= 0 || stackSize <= 0) return;
            buyCart.push({ name, qty, bundleSize: stackSize, price, isFullyCustom: true, source: 'CUSTOM' }); renderBuyList();
        }

        function addSellStack() {
            const name = document.getElementById("sellStackSelect").value;
            const qty = parseInt(document.getElementById("sellStackQty").value) || 0;
            const item = items.find(i => i.name === name); if (!item || !item.buyStack) return;
            sellCart.push({ name: item.name, qty, price: item.buyStack, bundleSize: item.bundleSize, source: 'STORE' }); renderSellList();
        }
        function addSellIndividual() {
            const name = document.getElementById("sellIndivSelect").value;
            const qty = parseInt(document.getElementById("sellIndivQty").value) || 0;
            const item = items.find(i => i.name === name); if (!item || !item.buyEach) return;
            sellCart.push({ name: item.name, qty, price: item.buyEach, source: 'STORE' }); renderSellList();
        }
        function addAccountBalance() {
            const balance = parseFloat(document.getElementById("accountBalanceInput").value) || 0;
            if (balance <= 0) return;
            sellCart.push({ name: "Account Balance", qty: 1, price: balance, isBalance: true, source: 'BALANCE' }); renderSellList();
        }
        function addCustomSellStack() {
            const name = document.getElementById("customSellStackSelect").value;
            const qty = parseInt(document.getElementById("customSellStackQty").value) || 0;
            const price = parseFloat(document.getElementById("customSellStackPrice").value) || 0;
            const item = items.find(i => i.name === name);
            if (!item || qty <= 0 || price <= 0) return;
            sellCart.push({ name: item.name, qty, price, bundleSize: item.bundleSize, isCustom: true, source: 'STORE' }); renderSellList();
        }
        function addCustomSellIndividual() {
            const name = document.getElementById("customSellIndivSelect").value;
            const qty = parseInt(document.getElementById("customSellIndivQty").value) || 0;
            const price = parseFloat(document.getElementById("customSellIndivPrice").value) || 0;
            const item = items.find(i => i.name === name);
            if (!item || qty <= 0 || price <= 0) return;
            sellCart.push({ name: item.name, qty, price, isCustom: true, source: 'STORE' }); renderSellList();
        }
        function addFullyCustomSell() {
            const name = document.getElementById("customSellName").value.trim();
            const qty = parseInt(document.getElementById("customSellQty").value) || 0;
            const stackSize = parseInt(document.getElementById("customSellStackSize").value) || 1;
            const price = parseFloat(document.getElementById("customSellPrice").value) || 0;
            if (!name || qty <= 0 || price <= 0 || stackSize <= 0) return;
            sellCart.push({ name, qty, bundleSize: stackSize, price, isFullyCustom: true, source: 'CUSTOM' }); renderSellList();
        }

        /* ===== OCM Listings ===== */
        function refreshOCMBuy() {
            const q = document.getElementById('ocmBuyQuery').value.trim();
            fetch(`${WEB_APP_URL}?action=listings&q=${encodeURIComponent(q)}`)
                .then(r => r.json()).then(j => {
                    if (!j.ok) throw new Error(j.error);
                    ocmListingsCacheBuy = j.data.filter(l => l.type === 'SELL');
                    renderOCMListings('ocmBuyListings', ocmListingsCacheBuy);
                }).catch(e => document.getElementById('ocmBuyListings').textContent = 'Error: ' + e.message);
        }
        function refreshOCMSell() {
            const q = document.getElementById('ocmSellQuery').value.trim();
            fetch(`${WEB_APP_URL}?action=listings&q=${encodeURIComponent(q)}`)
                .then(r => r.json()).then(j => {
                    if (!j.ok) throw new Error(j.error);
                    ocmListingsCacheSell = j.data.filter(l => l.type === 'BUY');
                    renderOCMListings('ocmSellListings', ocmListingsCacheSell);
                }).catch(e => document.getElementById('ocmSellListings').textContent = 'Error: ' + e.message);
        }
        function renderOCMListings(containerId, arr) {
            const el = document.getElementById(containerId); el.innerHTML = '';
            if (!arr.length) { el.textContent = 'No listings'; return; }
            arr.forEach(l => {
                const div = document.createElement('div'); div.className = 'ocm-listing';
                div.textContent = `${l.itemName} | ${l.type} | ${l.unit} | price:${l.priceBT} | qty:${l.qtyAvailable || '‚àû'} | by ${l.playerName}`;
                div.dataset.listingId = l.listingId;
                div.onclick = () => {
                    Array.from(el.children).forEach(c => c.classList.remove('highlight-action'));
                    div.classList.add('highlight-action');
                    el.dataset.selectedListingId = l.listingId;
                };
                el.appendChild(div);
            });
        }
        function addOCMBuy() {
            if (!googleIdToken) { alert('You need to login for this tool'); return; }
            const id = document.getElementById('ocmBuyListings').dataset.selectedListingId;
            if (!id) return alert('Select an OCM SELL listing first');
            const listing = ocmListingsCacheBuy.find(l => l.listingId === id);
            const qty = parseInt(document.getElementById('ocmBuyQty').value) || 0;
            if (!listing || qty <= 0) return;
            buyCart.push({ name: listing.itemName, qty, price: Number(listing.priceBT), source: 'OCM', listingId: id });
            renderBuyList();
        }
        function addOCMSell() {
            if (!googleIdToken) { alert('You need to login for this tool'); return; }
            const id = document.getElementById('ocmSellListings').dataset.selectedListingId;
            if (!id) return alert('Select an OCM BUY listing first');
            const listing = ocmListingsCacheSell.find(l => l.listingId === id);
            const qty = parseInt(document.getElementById('ocmSellQty').value) || 0;
            if (!listing || qty <= 0) return;
            sellCart.push({ name: listing.itemName, qty, price: Number(listing.priceBT), source: 'OCM', listingId: id });
            renderSellList();
        }

        /* ===== Row coloring ===== */
        function evaluateRowColorBuy(entry) {
            const item = items.find(i => i.name === entry.name);
            const prog = stockProgressCache.find(sp => sp.name === entry.name);
            if (!item && !prog) return null;
            if (entry.source === 'OCM') return null;
            const bundleSize = item ? (item.bundleSize || 1) : 1;
            const requestedStacks = entry.bundleSize ? Number(entry.qty || 0) : (Number(entry.qty || 0) / bundleSize);
            const availableStacks = item ? (Number(item.stackStock || 0) + (Number(item.indivStock || 0) / bundleSize)) : (prog ? prog.currentStacks : 0);
            if (availableStacks <= 0) return 'row-warning-red';
            const ratio = requestedStacks / availableStacks;
            if (ratio > 1) return 'row-warning-red';
            if (ratio > 0.5) return 'row-warning-yellow';
            return null;
        }
        function evaluateRowColorSell(entry) {
            const prog = stockProgressCache.find(sp => sp.name === entry.name);
            const item = items.find(i => i.name === entry.name);
            if (!prog || entry.source === 'OCM') return null;
            const bundleSize = item ? (Number(item.bundleSize || 1) || 1) : 1;
            const sellingStacks = entry.bundleSize ? Number(entry.qty || 0) : (Number(entry.qty || 0) / bundleSize);
            const currentStacks = Number(prog.currentStacks || 0);
            const projected = currentStacks + sellingStacks;
            const effectiveTarget = Number(item?.targetEach || 0);
            if (effectiveTarget > 0 && projected > effectiveTarget) return 'row-warning-red';
            return null;
        }

        function formatValue(btValue, currencyName, forBuy) {
            if (isNaN(btValue)) btValue = 0;
            let txt = `${btValue.toFixed(2)} ${BASE_CURRENCY}`;
            if (currencyName && currencyName !== BASE_CURRENCY) {
                const currency = items.find(i => i.name.toLowerCase() === currencyName.toLowerCase());
                if (currency) {
                    const rate = forBuy ? (currency.buyEach || currency.buyStack || 0) : (currency.sellEach || currency.sellStack || 0);
                    if (rate > 0) { txt += ` (‚âà ${(btValue / rate).toFixed(2)} ${currencyName})`; }
                }
            }
            return txt;
        }

        function renderBuyList() {
            const list = document.getElementById("buyList"); list.innerHTML = "";
            let total = 0; const curr = document.getElementById("currencySelect").value;
            buyCart.forEach(e => {
                const li = document.createElement("li");
                let rowTotal = 0, rowText = "";
                if (e.isBalance) { rowTotal = e.price || 0; rowText = `Account Balance: ${rowTotal.toFixed(2)} BT`; }
                else if (e.bundleSize && e.isFullyCustom) { rowTotal = (e.qty / e.bundleSize) * e.price; rowText = `${e.qty} √ó ${e.name} (${e.price.toFixed(2)} BT per ${e.bundleSize}) (${rowTotal.toFixed(2)} BT)`; }
                else if (e.bundleSize) { rowTotal = e.qty * e.price; rowText = `${e.qty} √ó ${e.bundleSize} ${e.name} (${e.price.toFixed(2)} BT stack) (${rowTotal.toFixed(2)} BT)`; }
                else { rowTotal = e.qty * e.price; rowText = `${e.qty} √ó ${e.name} (${e.price.toFixed(2)} BT each) (${rowTotal.toFixed(2)} BT)`; }
                total += rowTotal;
                if (e.isConverter) rowText += ' [Converted]';
                if (e.source === 'OCM') rowText += ' [OCM]';
                const colorClass = evaluateRowColorBuy(e);
                if (colorClass) li.classList.add(colorClass);
                if (curr && curr !== BASE_CURRENCY) rowText += ' ' + formatValue(rowTotal, curr, true);
                li.textContent = rowText;
                const removeBtn = document.createElement("button");
                removeBtn.textContent = "‚ùå"; removeBtn.onclick = () => { buyCart = buyCart.filter(x => x !== e); renderBuyList(); calculateNet(); };
                li.appendChild(removeBtn);
                list.appendChild(li);
            });
            document.getElementById("buyTotal").textContent = formatValue(total, curr, true);
            calculateNet();
        }

        function renderSellList() {
            const list = document.getElementById("sellList"); list.innerHTML = "";
            let total = 0; const curr = document.getElementById("currencySelect").value;

            // Always show pinned Account Balance first (visual order)
            const pinned = sellCart.filter(e => e.isAccountBalancePinned);
            const others = sellCart.filter(e => !e.isAccountBalancePinned);
            const rows = [...pinned, ...others];

            rows.forEach(e => {
                const li = document.createElement("li");
                let rowTotal = 0, rowText = "";
                if (e.isBalance) {
                    rowTotal = e.price || 0;
                    rowText = e.isAccountBalancePinned
                        ? `Account Balance (auto): ${rowTotal.toFixed(2)} BT`
                        : `Account Balance: ${rowTotal.toFixed(2)} BT`;
                } else if (e.bundleSize && e.isFullyCustom) {
                    rowTotal = (e.qty / e.bundleSize) * e.price; rowText = `${e.qty} √ó ${e.name} (${e.price.toFixed(2)} BT per ${e.bundleSize}) (${rowTotal.toFixed(2)} BT)`;
                } else if (e.bundleSize) {
                    rowTotal = e.qty * e.price; rowText = `${e.qty} √ó ${e.bundleSize} ${e.name} (${e.price.toFixed(2)} BT stack) (${rowTotal.toFixed(2)} BT)`;
                } else {
                    rowTotal = e.qty * e.price; rowText = `${e.qty} √ó ${e.name} (${e.price.toFixed(2)} BT each) (${rowTotal.toFixed(2)} BT)`;
                }
                if (e.isPayWith) rowText += ' [Pay With]';
                if (e.source === 'OCM') rowText += ' [OCM]';
                total += rowTotal;

                const colorClass = evaluateRowColorSell(e);
                if (colorClass) {
                    li.classList.add(colorClass);
                    if (colorClass === 'row-warning-red') {
                        const warn = document.createElement('span'); warn.className = 'small-note';
                        warn.textContent = 'over target stock';
                        li.appendChild(warn);
                    }
                }
                if (curr && curr !== BASE_CURRENCY) rowText += ' ' + formatValue(rowTotal, curr, false);
                li.textContent = rowText;

                // Do not allow removing the auto-imported balance row
                if (!e.isAccountBalancePinned) {
                    const removeBtn = document.createElement("button");
                    removeBtn.textContent = "‚ùå"; removeBtn.onclick = () => { sellCart = sellCart.filter(x => x !== e); renderSellList(); calculateNet(); };
                    li.appendChild(removeBtn);
                }

                list.appendChild(li);
            });

            document.getElementById("sellTotal").textContent = formatValue(total, curr, false);
            calculateNet();
        }

        function calculateNet() {
            const buyTotal = buyCart.reduce((s, e) => {
                if (e.isBalance) return s + (e.price || 0);
                if (e.bundleSize && e.isFullyCustom) return s + ((e.qty / e.bundleSize) * e.price);
                if (e.bundleSize) return s + (e.qty * e.price);
                return s + (e.qty * e.price);
            }, 0);
            const sellTotal = sellCart.reduce((s, e) => {
                if (e.isBalance) return s + (e.price || 0);
                if (e.bundleSize && e.isFullyCustom) return s + ((e.qty / e.bundleSize) * e.price);
                if (e.bundleSize) return s + (e.qty * e.price);
                return s + (e.qty * e.price);
            }, 0);
            const net = sellTotal - buyTotal;
            const curr = document.getElementById("currencySelect").value;
            const netSpan = document.getElementById("netTotal");
            netSpan.dataset.raw = String(net);
            netSpan.textContent = formatValue(net, curr, net < 0);
            netSpan.className = net >= 0 ? 'positive' : 'negative';
        }

        function addPayRow() {
            const div = document.createElement("div"); div.className = "payRow";
            const unique = 'paySelect_' + Date.now() + '_' + Math.floor(Math.random() * 10000);
            const input = document.createElement("input"); input.id = unique; input.className = 'dropdown-input'; input.placeholder = 'Item name';
            const list = document.createElement("div"); list.id = unique + 'List'; list.className = 'dropdown-list'; list.style.display = 'none';
            const wrap = document.createElement('div'); wrap.className = 'dropdown-wrap'; wrap.appendChild(input); wrap.appendChild(list);

            const percent = document.createElement("input"); percent.type = "number"; percent.value = 100; percent.min = 0; percent.max = 100; percent.placeholder = "%";

            const removeRowBtn = document.createElement("button"); removeRowBtn.type = "button"; removeRowBtn.textContent = "‚ùå";
            removeRowBtn.onclick = () => { div.remove(); calculatePayment(); };

            div.appendChild(wrap); div.appendChild(document.createTextNode(" % of total: ")); div.appendChild(percent); div.appendChild(removeRowBtn);
            document.getElementById("payOptions").appendChild(div);

            attachDropdown(input.id, list.id, (q) => {
                const ql = (q || "").toLowerCase();
                if (!ql) return dropdownData.slice(0, 200);
                return dropdownData.filter(d => d.name.toLowerCase().includes(ql));
            }, () => { });

            input.focus();
        }

        function calculatePayment() {
            const payListEl = document.getElementById("payList"); payListEl.innerHTML = "";
            const netSpan = document.getElementById("netTotal");
            const netRaw = parseFloat(netSpan.dataset.raw);
            const totalNet = !isNaN(netRaw) ? netRaw : parseFloat((netSpan.textContent || "0").replace(/[^\d.-]/g, "")) || 0;
            if (totalNet >= 0) {
                document.getElementById("paymentResult").textContent = `‚úÖ Net Balance is ${totalNet.toFixed(2)} BT. No payment needed.`;
                sellCart = sellCart.filter(e => !e.isPayWith);
                renderSellList(); calculateNet(); return;
            }

            const owed = -totalNet;
            sellCart = sellCart.filter(e => !e.isPayWith);
            const curr = document.getElementById("currencySelect").value;
            const rows = Array.from(document.querySelectorAll("#payOptions .payRow"));

            const computed = [];
            let usedPercent = 0;

            rows.forEach(row => {
                const inputEl = row.querySelector('input.dropdown-input');
                const percentEl = row.querySelector('input[type="number"]');
                const rawName = (inputEl?.value || "").trim();
                const percent = parseFloat(percentEl?.value) || 0;
                if (!rawName || percent <= 0) return;

                const item = payItems.find(i => i.name.toLowerCase() === rawName.toLowerCase())
                    || payItems.find(i => i.name.toLowerCase().includes(rawName.toLowerCase()));
                if (!item) return;

                usedPercent += percent;
                const portion = (percent / 100) * owed;

                const stackPrice = item.buyStack || (item.buyEach && item.bundleSize ? item.buyEach * item.bundleSize : 0);
                const indivPrice = item.buyEach || (item.buyStack && item.bundleSize ? item.buyStack / item.bundleSize : 0);

                let stacks = 0, individuals = 0, leftover = portion;
                if (stackPrice > 0) { stacks = Math.floor(portion / stackPrice); leftover -= stacks * stackPrice; }
                if (indivPrice > 0 && leftover > 0) { const addIndividuals = Math.floor(leftover / indivPrice); individuals += addIndividuals; leftover -= addIndividuals * indivPrice; }

                computed.push({
                    item, percent, stacks, individuals, stackPrice, indivPrice
                });
            });

            const sumProvided = () => computed.reduce((s, c) => s + (c.stacks * (c.stackPrice || 0)) + (c.individuals * (c.indivPrice || 0)), 0);
            let provided = sumProvided();
            let remaining = owed - provided;

            if (remaining > 0) {
                const indivRows = computed.filter(c => c.indivPrice > 0).sort((a, b) => a.indivPrice - b.indivPrice);
                for (const c of indivRows) {
                    while (remaining > 0 && c.indivPrice > 0) {
                        c.individuals += 1;
                        remaining -= c.indivPrice;
                        provided += c.indivPrice;
                        if (remaining <= 0) break;
                        if (c.individuals > 10000) break;
                    }
                    if (remaining <= 0) break;
                }
            }

            if (remaining > 0) {
                const stackRows = computed.filter(c => c.stackPrice > 0).sort((a, b) => a.stackPrice - b.stackPrice);
                for (const c of stackRows) {
                    while (remaining > 0 && c.stackPrice > 0) {
                        c.stacks += 1;
                        remaining -= c.stackPrice;
                        provided += c.stackPrice;
                        if (remaining <= 0) break;
                        if (c.stacks > 10000) break;
                    }
                    if (remaining <= 0) break;
                }
            }

            computed.forEach(c => {
                if ((c.stacks === 0) && (c.individuals === 0)) return;
                const payId = 'pay_' + Date.now() + '_' + Math.floor(Math.random() * 10000);
                const li = document.createElement("li"); li.dataset.payid = payId;
                let payText = `${c.percent}% = `;
                if (c.stacks > 0) payText += `${c.stacks} stack(s) √ó ${c.item.bundleSize} ${c.item.name} (${(c.stackPrice || 0).toFixed(2)} BT stack)`;
                if (c.individuals > 0) { if (c.stacks > 0) payText += ' + '; payText += `${c.individuals} √ó ${c.item.name} (${(c.indivPrice || 0).toFixed(2)} BT each)`; }
                const totalBT = c.stacks * (c.stackPrice || 0) + c.individuals * (c.indivPrice || 0);
                payText += ` (${totalBT.toFixed(2)} BT)`;
                if (curr && curr !== BASE_CURRENCY) payText += ' ' + formatValue(totalBT, curr, false);
                li.textContent = payText;
                const removeBtn = document.createElement("button"); removeBtn.textContent = "‚ùå";
                removeBtn.onclick = () => { sellCart = sellCart.filter(it => !(it.isPayWith && it._payId === payId)); li.remove(); renderSellList(); calculateNet(); };
                li.appendChild(removeBtn);
                payListEl.appendChild(li);

                if (c.stacks > 0) sellCart.push({ name: c.item.name, qty: c.stacks, price: c.stackPrice, bundleSize: c.item.bundleSize, isPayWith: true, _payId: payId });
                if (c.individuals > 0) sellCart.push({ name: c.item.name, qty: c.individuals, price: c.indivPrice, isPayWith: true, _payId: payId });
            });

            const finalProvided = sumProvided();
            const finalRemaining = Math.max(0, owed - finalProvided);

            if (finalProvided >= owed) {
                document.getElementById("paymentResult").textContent = `‚úÖ Covered. Payment items total ${finalProvided.toFixed(2)} BT (needed ${owed.toFixed(2)} BT).`;
            } else {
                document.getElementById("paymentResult").textContent = `‚ö†Ô∏è Unable to fully cover owed amount. Still missing ${finalRemaining.toFixed(2)} BT.`;
            }

            renderSellList(); calculateNet();
        }

        function addConverterRow() {
            const div = document.createElement("div"); div.className = "payRow";
            const unique = 'convSelect_' + Date.now() + '_' + Math.floor(Math.random() * 10000);
            const input = document.createElement("input"); input.id = unique; input.className = 'dropdown-input'; input.placeholder = 'Item name';
            const list = document.createElement("div"); list.id = unique + 'List'; list.className = 'dropdown-list'; list.style.display = 'none';
            const wrap = document.createElement('div'); wrap.className = 'dropdown-wrap'; wrap.appendChild(input); wrap.appendChild(list);

            const percent = document.createElement("input"); percent.type = "number"; percent.value = 100; percent.min = 0; percent.max = 100; percent.placeholder = "%";

            const removeRowBtn = document.createElement("button"); removeRowBtn.type = "button"; removeRowBtn.textContent = "‚ùå";
            removeRowBtn.onclick = () => { div.remove(); calculateConversion(); };

            div.appendChild(wrap); div.appendChild(document.createTextNode(" % of Net Balance: ")); div.appendChild(percent); div.appendChild(removeRowBtn);
            document.getElementById("converterOptions").appendChild(div);

            attachDropdown(input.id, list.id, (q) => {
                const ql = (q || "").toLowerCase();
                if (!ql) return dropdownData.slice(0, 200);
                return dropdownData.filter(d => d.name.toLowerCase().includes(ql));
            }, () => { });

            input.focus();
        }

        function calculateConversion() {
            const converterList = document.getElementById("converterListDisplay");
            converterList.innerHTML = '';
            const netBT = parseFloat(document.getElementById("netTotal").dataset.raw) || 0;
            if (netBT <= 0) { document.getElementById("converterResult").textContent = '‚ö†Ô∏è Net Balance not positive.'; return; }
            buyCart = buyCart.filter(e => !e.isConverter);
            const rows = document.querySelectorAll("#converterOptions .payRow");
            let usedPercent = 0;
            rows.forEach(row => {
                const inputEl = row.querySelector('input.dropdown-input');
                const name = inputEl?.value.trim() || '';
                const percent = parseFloat(row.querySelector('input[type="number"]').value) || 0;
                const item = items.find(i => i.name === name);
                if (!item || percent <= 0) return;
                usedPercent += percent;
                const portion = (percent / 100) * netBT;
                let stackPrice = item.sellStack || (item.sellEach && item.bundleSize ? item.sellEach * item.bundleSize : 0);
                let indivPrice = item.sellEach || (item.sellStack && item.bundleSize ? item.sellStack / item.bundleSize : 0);
                if (!stackPrice && !indivPrice) return;
                let stacks = 0, individuals = 0, leftover = portion;
                if (stackPrice > 0) { stacks = Math.floor(portion / stackPrice); leftover -= stacks * stackPrice; }
                if (indivPrice > 0) { const addIndividuals = Math.floor(leftover / indivPrice); individuals += addIndividuals; leftover -= addIndividuals * indivPrice; }
                const rowId = 'conv_' + Date.now() + '_' + Math.floor(Math.random() * 10000);
                if (stacks > 0) buyCart.push({ name: item.name, qty: stacks, price: stackPrice, bundleSize: item.bundleSize, isConverter: true, _rowId: rowId });
                if (individuals > 0) buyCart.push({ name: item.name, qty: individuals, price: indivPrice, isConverter: true, _rowId: rowId });
                const li = document.createElement('li');
                let txt = `${percent}% = `;
                if (stacks > 0) txt += `${stacks} stack(s) √ó ${item.bundleSize} ${item.name} (${stackPrice.toFixed(2)} BT stack)`;
                if (individuals > 0) { if (stacks > 0) txt += ' + '; txt += `${individuals} √ó ${item.name} (${indivPrice.toFixed(2)} BT each)`; }
                const totalBT = stacks * stackPrice + individuals * indivPrice;
                txt += ` (${totalBT.toFixed(2)} BT)`;
                const curr = document.getElementById("currencySelect").value;
                if (curr && curr !== BASE_CURRENCY) txt += ' ' + formatValue(totalBT, curr, true);
                li.textContent = txt;
                const removeBtn = document.createElement('button'); removeBtn.textContent = '‚ùå';
                removeBtn.onclick = () => { buyCart = buyCart.filter(e => !(e.isConverter && e._rowId === rowId)); li.remove(); renderBuyList(); calculateNet(); };
                li.appendChild(removeBtn);
                converterList.appendChild(li);
            });
            renderBuyList();
            document.getElementById("converterResult").textContent = usedPercent === 0
                ? '‚ö†Ô∏è No allocations set.'
                : `‚úÖ Conversion done. Allocated ${usedPercent}% of Net Balance.`;
        }

        /* ===== Requests ===== */
        function buildRequestPayload() {
            // include flags so backend/history can show "Account Balance" row
            const mapRow = r => ({
                name: r.name,
                qty: r.qty,
                priceBT: r.price,
                bundleSize: r.bundleSize || null,
                source: r.source || 'STORE',
                isBalance: !!r.isBalance
            });

            const buyItems = buyCart.map(mapRow);
            const sellItems = sellCart.map(mapRow);

            const totals = {
                buyBT: buyItems.reduce((s, i) => s + (i.priceBT * (i.bundleSize ? i.qty : i.qty)), 0),
                sellBT: sellItems.reduce((s, i) => s + (i.priceBT * (i.bundleSize ? i.qty : i.qty)), 0)
            };
            totals.netBT = totals.sellBT - totals.buyBT;

            const baseUser = (window.submitForUser && currentUser?.isAdmin)
                ? window.submitForUser
                : {
                    userId: currentUser?.userId,
                    email: currentUser?.email,
                    playerName: currentUser?.playerName,
                    mailbox: currentUser?.mailbox
                };

            return {
                requestId: cryptoRandomId(),
                createdAt: new Date().toISOString(),
                user: baseUser,
                carts: { buy: buyItems, sell: sellItems },
                totals,
                priceSource: { sheetId: 'PRICE_SHEET', asOf: new Date().toISOString() },
                editedFromRequestId: window.editedFromRequestId || null,
                meta: (currentUser?.isAdmin && window.submitForUser) ? {
                    submittedByAdmin: true,
                    adminEmail: currentUser?.email
                } : null
            };
        }

        function guardedSubmitPurchaseRequest() {
            if (!googleIdToken) { alert('You need to login for this tool'); return; }
            submitPurchaseRequest();
        }
        function guardedCopyTransactionData() {
            if (!googleIdToken) { alert('You need to login for this tool'); return; }
            copyTransactionData();
        }

        function submitPurchaseRequest() {
            const payload = buildRequestPayload();
            const skipCaptcha = currentUser && currentUser.captchaPassed;
            const doPost = (tokenOrNull) => {
                const body = { action: 'createRequest', idToken: googleIdToken, payload };
                if (tokenOrNull) body.recaptchaToken = tokenOrNull;
                if (currentUser?.isAdmin && window.submitForUser) {
                    body.onBehalfOf = payload.user; // server should add to player's history
                }
                return fetch(WEB_APP_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
            };
            (skipCaptcha ? Promise.resolve(null) : recaptchaWrap())
                .then(token => doPost(token))
                .then(r => r.json())
                .then(j => {
                    if (!j.ok) throw new Error(j.error);
                    document.getElementById('requestMsg').textContent = 'Request submitted. ID: ' + (j.result.requestId || payload.requestId);
                    window.editedFromRequestId = null;
                    refreshOpenOrders();
                })
                .catch(e => document.getElementById('requestMsg').textContent = 'Error: ' + e.message);
        }

        function copyTransactionData() {
            const payload = buildRequestPayload();
            navigator.clipboard.writeText(JSON.stringify(payload, null, 2))
                .then(() => document.getElementById('requestMsg').textContent = 'Transaction data copied.')
                .catch(e => document.getElementById('requestMsg').textContent = 'Copy failed: ' + e.message);
        }

        /* ===== Admin: on-behalf selector ===== */
        function normalizeStr(s) { return (s || '').toLowerCase().trim(); }
        function score(candidate, query) {
            const c = normalizeStr(candidate);
            const q = normalizeStr(query);
            if (!q) return 0;
            if (c.startsWith(q)) return 100 - (c.length - q.length);
            const idx = c.indexOf(q);
            if (idx >= 0) return 60 - idx;
            const tokens = q.split(/\s+/).filter(Boolean);
            let hits = 0;
            tokens.forEach(t => { if (c.indexOf(t) >= 0) hits++; });
            return hits > 0 ? 30 + hits : -1;
        }
        function attachOnBehalfSearch() {
            const input = document.getElementById('obPlayerSearchInput');
            const list = document.getElementById('obPlayerSearchList');
            if (!input || !list) return;
            input.addEventListener('input', () => {
                const q = input.value;
                const filtered = __playersCache.map(p => ({
                    ...p,
                    _score: Math.max(
                        score(`${p.playerName || ''}`, q),
                        score(`${p.email || ''}`, q),
                        score(`${p.userId || ''}`, q)
                    )
                }))
                    .filter(p => p._score >= 0)
                    .sort((a, b) => b._score - a._score)
                    .slice(0, 200);
                list.innerHTML = '';
                if (!filtered.length) { list.style.display = 'none'; return; }
                filtered.forEach(p => {
                    const div = document.createElement('div');
                    div.className = 'dropdown-item';
                    div.innerHTML = `<div><strong>${p.playerName || '(no name)'}</strong><br><small>${p.email || ''}</small></div>`;
                    div.onclick = () => {
                        input.value = p.playerName || p.email || p.userId;
                        input.dataset.userId = p.userId || '';
                        list.style.display = 'none';
                    };
                    list.appendChild(div);
                });
                list.style.display = 'block';
            });
            input.addEventListener('focus', () => input.dispatchEvent(new Event('input')));
            input.addEventListener('blur', () => setTimeout(() => list.style.display = 'none', 200));
        }

        async function adminLoadPlayers() {
            const st = document.getElementById('onBehalfStatus');
            try {
                if (!googleIdToken) return;
                const r = await fetch(`${WEB_APP_URL}?action=adminListPlayers&idToken=${encodeURIComponent(googleIdToken)}`);
                const j = await r.json();
                if (!j.ok) throw new Error(j.error || 'adminListPlayers failed');
                const arr = Array.isArray(j.data) ? j.data : (j.data?.players || []);
                __playersCache.length = 0;
                arr.forEach(p => __playersCache.push({ userId: p.userId, email: p.email, playerName: p.playerName, mailbox: p.mailbox }));
                if (st) st.textContent = `Loaded ${__playersCache.length} players.`;
            } catch (e) {
                if (st) st.textContent = 'Load players failed: ' + e.message;
            }
        }

        // Fetch and pin balance for active target (current user or on-behalf user)
        function getActiveTarget() {
            return window.submitForUser || currentUser;
        }
        async function fetchBalanceForUser(user) {
            if (!googleIdToken || !user) return 0;
            const qs = new URLSearchParams({ action: 'getBalance', idToken: googleIdToken });
            if (user.userId) qs.append('userId', user.userId);
            const r = await fetch(`${WEB_APP_URL}?${qs.toString()}`);
            const j = await r.json();
            if (!j.ok) throw new Error(j.error || 'getBalance failed');
            const v = Number(j.data?.balanceBT ?? j.balanceBT ?? j.data?.balance ?? 0);
            return isNaN(v) ? 0 : v;
        }
        function upsertPinnedBalanceRow(balanceBT) {
            // remove prior pinned balance
            sellCart = sellCart.filter(e => !e.isAccountBalancePinned);
            // add fresh pinned at beginning (data order doesn't matter; render keeps it top)
            sellCart.unshift({
                name: 'Account Balance',
                qty: 1,
                price: Number(balanceBT) || 0,
                isBalance: true,
                isAccountBalancePinned: true,
                source: 'BALANCE'
            });
            renderSellList();
            calculateNet();
        }
        async function refreshPinnedBalanceForActiveTarget() {
            const target = getActiveTarget();
            if (!target || !googleIdToken) return;
            try {
                const bal = await fetchBalanceForUser(target);
                upsertPinnedBalanceRow(bal);
                const st = document.getElementById('onBehalfStatus');
                if (st && window.submitForUser) st.textContent = `Target set: ${target.playerName || target.email || target.userId}. Balance: ${bal.toFixed(2)} BT`;
            } catch (e) {
                // leave any existing pinned row; surface message for admins
                const st = document.getElementById('onBehalfStatus');
                if (st) st.textContent = `Balance load failed: ${e.message}`;
            }
        }

        async function setOnBehalfTarget() {
            if (!currentUser?.isAdmin) return alert('Admin only');
            const input = document.getElementById('obPlayerSearchInput');
            const userId = input?.dataset?.userId || '';
            const st = document.getElementById('onBehalfStatus');
            if (!userId) { st.textContent = 'Select a player from the list first.'; return; }
            const u = __playersCache.find(p => p.userId === userId);
            if (!u) { st.textContent = 'Selected player not found.'; return; }
            window.submitForUser = {
                userId: u.userId,
                email: u.email || null,
                playerName: u.playerName || null,
                mailbox: u.mailbox || null
            };
            st.textContent = `Target set: ${u.playerName || u.email || u.userId}. Loading balance...`;
            try { await refreshPinnedBalanceForActiveTarget(); } catch { }
        }
        async function clearOnBehalfTarget() {
            window.submitForUser = null;
            const st = document.getElementById('onBehalfStatus');
            if (st) st.textContent = 'On-behalf target cleared. Loading your balance...';
            try { await refreshPinnedBalanceForActiveTarget(); } catch { }
            const input = document.getElementById('obPlayerSearchInput');
            if (input) { input.value = ''; input.dataset.userId = ''; }
        }

        /* ===== Open Orders Indicator ===== */
        function setStatusBall(state) {
            const el = document.getElementById('orderStatusBall');
            if (!el) return;
            el.className = '';
            el.classList.add({
                pending: 'status-pending',
                error: 'status-error',
                none: 'status-none'
            }[state] || 'status-none');
        }

        async function refreshOpenOrders() {
            try {
                if (!googleIdToken) { setStatusBall('none'); return; }
                const r = await fetch(`${WEB_APP_URL}?action=myOpenOrders&idToken=${encodeURIComponent(googleIdToken)}`);
                const j = await r.json();
                if (!j.ok) throw new Error(j.error || 'myOpenOrders failed');
                const { requests, trades } = j.data || { requests: [], trades: [] };
                const hasPending = (requests && requests.length) || (trades && trades.length);
                setStatusBall(hasPending ? 'pending' : 'none');
                const body = document.getElementById('orderPopupBody');
                body.innerHTML = '';
                if (!hasPending) { body.textContent = 'No open requests or trades.'; return; }
                if (requests && requests.length) {
                    const h = document.createElement('div'); h.textContent = 'Requests:'; h.style.fontWeight = 'bold'; body.appendChild(h);
                    requests.forEach(rq => {
                        const div = document.createElement('div');
                        const a = document.createElement('span'); a.className = 'order-link'; a.textContent = `Edit request ${rq.requestId}`;
                        a.onclick = () => loadRequestIntoEditorFromData(rq);
                        div.appendChild(a);
                        body.appendChild(div);
                    });
                }
                if (trades && trades.length) {
                    const h = document.createElement('div'); h.textContent = 'OCM Trades:'; h.style.fontWeight = 'bold'; h.style.marginTop = '6px'; body.appendChild(h);
                    trades.forEach(t => {
                        const div = document.createElement('div');
                        div.textContent = `Trade ${t.tradeId} qty=${t.quantity} price=${t.price}`;
                        body.appendChild(div);
                    });
                }
            } catch (e) {
                setStatusBall('error');
                const body = document.getElementById('orderPopupBody');
                body.textContent = 'Error loading open orders: ' + e.message;
            }
        }

        function toggleOrderPopup() {
            const p = document.getElementById('orderPopup');
            p.style.display = (p.style.display === 'none' || !p.style.display) ? 'block' : 'none';
        }

        document.addEventListener('click', (ev) => {
            const p = document.getElementById('orderPopup');
            const b = document.getElementById('orderStatusBall');
            if (!p || !b) return;
            if (b.contains(ev.target)) { toggleOrderPopup(); return; }
            if (!p.contains(ev.target)) p.style.display = 'none';
        });

        function loadRequestIntoEditorFromData(rq) {
            if (!googleIdToken) { alert('You need to login for this tool'); return; }
            buyCart = []; sellCart = [];
            (rq.items || []).forEach(it => {
                const row = { name: it.itemName, qty: Number(it.quantity || 0), price: Number(it.price || 0) };
                if (it.side === 'buy') buyCart.push(row);
                else if (it.side === 'sell') sellCart.push(row);
            });
            window.editedFromRequestId = rq.requestId || null;
            updateAllDisplays();
            toggleOrderPopup();
            alert('Request loaded. Edit and Submit to resend (old request cancelled).');
        }
        // Import Transaction Data ‚Äî supports clipboard paste, prompt paste, or JSON file
        async function importTransactionData() {
            if (!googleIdToken) { alert('You need to login for this tool'); return; }

            // 1) Try read JSON text from clipboard (best UX)
            try {
                if (navigator.clipboard?.readText) {
                    const txt = (await navigator.clipboard.readText()) || '';
                    if (txt.trim()) {
                        await importTransactionDataFromText(txt);
                        return;
                    }
                }
            } catch (_) { /* fall through */ }

            // 2) Ask user to paste JSON manually
            const pasted = window.prompt('Paste transaction JSON (from Copy Transaction Data), or leave empty to choose a file:');
            if (pasted && pasted.trim()) {
                await importTransactionDataFromText(pasted);
                return;
            }

            // 3) Fallback to file chooser
            const fileEl = document.getElementById('importFile');
            if (fileEl) fileEl.click();
            else alert('File input not found. Please add the hidden <input id="importFile" ...> element near the button.');
        }

        async function importTransactionDataFromFile(file) {
            if (!file) return;
            try {
                const txt = await file.text();
                await importTransactionDataFromText(txt);
            } catch (e) {
                document.getElementById('requestMsg').textContent = 'Import failed: ' + e.message;
            } finally {
                const fileEl = document.getElementById('importFile');
                if (fileEl) fileEl.value = ''; // reset
            }
        }

        async function importTransactionDataFromText(txt) {
            try {
                const payload = JSON.parse(txt);
                loadTransactionPayloadIntoEditor(payload);
                document.getElementById('requestMsg').textContent = 'Transaction data imported.';
            } catch (e) {
                document.getElementById('requestMsg').textContent = 'Invalid JSON: ' + e.message;
            }
        }

        // Accepts both current shape { carts:{buy:[...],sell:[...]}, ... }
        // and legacy shape { items:[{side:'buy'|'sell', itemName, quantity, price, bundleSize?}], ... }
        function loadTransactionPayloadIntoEditor(payload) {
            const asNumber = (v) => { const n = Number(v); return isFinite(n) ? n : 0; };

            // Normalize input to arrays of rows
            let buyRows = [];
            let sellRows = [];

            if (payload && payload.carts && (Array.isArray(payload.carts.buy) || Array.isArray(payload.carts.sell))) {
                // Current format used by copyTransactionData()
                buyRows = (payload.carts.buy || []).map(r => ({
                    name: r.name,
                    qty: asNumber(r.qty),
                    price: asNumber(r.priceBT),
                    bundleSize: r.bundleSize || null,
                    source: r.source || 'STORE',
                    isBalance: !!r.isBalance
                }));
                sellRows = (payload.carts.sell || []).map(r => ({
                    name: r.name,
                    qty: asNumber(r.qty),
                    price: asNumber(r.priceBT),
                    bundleSize: r.bundleSize || null,
                    source: r.source || 'STORE',
                    isBalance: !!r.isBalance
                }));
            } else if (Array.isArray(payload?.items)) {
                // Legacy shape: items[] with side, itemName, quantity, price
                payload.items.forEach(it => {
                    const row = {
                        name: it.itemName || it.name || 'Unknown',
                        qty: asNumber(it.quantity ?? it.qty),
                        price: asNumber(it.price ?? it.priceBT),
                        bundleSize: it.bundleSize || null,
                        source: it.source || 'STORE',
                        isBalance: !!it.isBalance
                    };
                    if (String(it.side).toLowerCase() === 'buy') buyRows.push(row);
                    else if (String(it.side).toLowerCase() === 'sell') sellRows.push(row);
                });
            } else {
                throw new Error('Unsupported payload shape.');
            }

            // Clear current carts
            buyCart = [];
            sellCart = [];

            // Preserve the auto-pinned balance row behavior:
            // - keep pinned row (isAccountBalancePinned) at the top of sellCart
            const pinned = sellCart.find(r => r.isAccountBalancePinned);

            // Load imported rows
            buyRows.forEach(r => {
                // fully custom rows
                if (r.bundleSize && !isNaN(r.bundleSize) && r.bundleSize > 0) {
                    buyCart.push({ name: r.name, qty: r.qty, bundleSize: r.bundleSize, price: r.price, source: r.source || 'CUSTOM' });
                } else {
                    buyCart.push({ name: r.name, qty: r.qty, price: r.price, source: r.source || 'STORE' });
                }
            });

            let importedSell = sellRows.map(r => {
                const row = r.bundleSize && !isNaN(r.bundleSize) && r.bundleSize > 0
                    ? { name: r.name, qty: r.qty, bundleSize: r.bundleSize, price: r.price, source: r.source || 'CUSTOM' }
                    : { name: r.name, qty: r.qty, price: r.price, source: r.source || 'STORE' };
                if (r.isBalance || r.name === 'Account Balance') {
                    row.isBalance = true;
                    row.source = 'BALANCE';
                }
                return row;
            });

            // If a pinned row exists, keep it first; otherwise just use imported order
            if (pinned) {
                sellCart.push(pinned);
                importedSell = importedSell.filter(r => !r.isAccountBalancePinned);
            }

            sellCart.push(...importedSell);

            // If payload.requestId exists, use it as edit marker so user can resubmit
            window.editedFromRequestId = payload.requestId || payload.editedFromRequestId || null;

            // If admin imports on behalf payload.user, optionally set target
            if (currentUser?.isAdmin && payload.user && (payload.user.userId || payload.user.email || payload.user.playerName)) {
                window.submitForUser = {
                    userId: payload.user.userId || null,
                    email: payload.user.email || null,
                    playerName: payload.user.playerName || null,
                    mailbox: payload.user.mailbox || null
                };
                // also refresh and pin the target's actual balance
                refreshPinnedBalanceForActiveTarget().catch(() => { /* non-fatal */ });
            }

            updateAllDisplays();
        }
        setInterval(() => { if (googleIdToken) refreshOpenOrders(); }, 15000);

        /* ===== Utilities ===== */
        function cryptoRandomId() { return (crypto.getRandomValues(new Uint32Array(4))).join('-'); }
        function updateAllDisplays() { renderBuyList(); renderSellList(); calculateNet(); }
        function toggleInfo(id) { const el = document.getElementById(id); el.style.display = el.style.display === 'block' ? 'none' : 'block'; }

        /* ===== Init ===== */
        async function tryRestoreAuthOnLoad() {
            if (!window.initAuthFromStorage) return;
            try {
                const res = await window.initAuthFromStorage();
                if (!res.ok) return;
                googleIdToken = res.idToken;
                try {
                    const meR = await fetch(`${WEB_APP_URL}?action=me&idToken=${encodeURIComponent(googleIdToken)}`);
                    const meJ = await meR.json();
                    if (!meJ.ok) {
                        window.clearSavedIdToken && window.clearSavedIdToken();
                        googleIdToken = null;
                        return;
                    }
                    currentUser = normalizeUser(meJ.data.user || null);
                    currentUser.isAdmin = !!meJ.data.isAdmin;
                    if (typeof updateTopBarAuth === 'function') updateTopBarAuth();
                    const adminBtn = document.getElementById('adminPanelBtn');
                    if (adminBtn) adminBtn.style.display = (currentUser.isAdmin ? 'inline' : 'none');
                    document.getElementById('onBehalfSection').style.display = currentUser.isAdmin ? 'block' : 'none';
                    if (currentUser.isAdmin) {
                        try { await adminLoadPlayers(); } catch { }
                    }
                    const hasSetup = currentUser && currentUser.playerName;
                    const passedCaptcha = currentUser && currentUser.captchaPassed;
                    if (hasSetup && passedCaptcha) {
                        localStorage.setItem('vak_captcha_ok', '1');
                        try { hideRecaptchaWidget(); } catch (_) { }
                        try { hideSetupShowApp(); } catch (_) { }
                    } else {
                        localStorage.removeItem('vak_captcha_ok');
                        try { showSetupOnly(); } catch (_) { }
                        try { showRecaptchaWidget(); } catch (_) { }
                    }
                    // Pin balance for current (no on-behalf yet)
                    try { await refreshPinnedBalanceForActiveTarget(); } catch { }
                    if (typeof refreshOpenOrders === 'function') refreshOpenOrders();
                } catch (e) {
                    console.warn('restore /me failed', e);
                }
            } catch (e) {
                console.warn('initAuthFromStorage failed', e);
            }
        }

        window.onload = () => {
            tryRestoreAuthOnLoad();

            document.body.classList.add('withTopBar');
            checkHashForIdToken();
            loadData();

            addPayRow();
            addConverterRow();

            initRecaptcha();

            const gsiWait = setInterval(() => {
                if (window.google && google.accounts && google.accounts.id) {
                    initGoogleIdentity();
                    clearInterval(gsiWait);
                }
            }, 200);
            setTimeout(() => clearInterval(gsiWait), 4000);

            initCollapsibles();
            updateTopBarAuth();

            // init admin on-behalf search UI
            attachOnBehalfSearch();
        };

    </script>
</body>
</html>