<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Admin Panel</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 1100px;
            margin: auto;
        }

        h1, h2 {
            margin-bottom: 8px;
        }

        .section {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
        }

        table {
            border-collapse: collapse;
            width: 100%;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 6px;
            text-align: left;
        }

        th {
            background: #f5f5f5;
        }

        .small {
            font-size: 12px;
            color: #555;
        }

        .row {
            margin-top: 8px;
        }

        input[type="number"], input[type="text"] {
            padding: 6px;
        }

        button {
            padding: 6px 10px;
            margin-right: 6px;
        }

        .muted {
            color: #777;
        }

        .danger {
            color: #b00;
        }

        .ok {
            color: #2a8f2a;
        }

        .grid2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        @media (max-width:900px) {
            .grid2 {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <script src="app-config.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="topbar.js"></script>
    <script src="api-client.js"></script>
</head>
<body>
    <h1>Admin Panel</h1>
    <div id="authStatus" class="small muted">Checking auth...</div>
    <div class="section">
        <h2>Pending Requests</h2>
        <div class="row">
            <label>
                Status:
                <select id="rqStatus">
                    <option value="">Any</option>
                    <option value="PENDING" selected>PENDING</option>
                    <option value="DENIED">DENIED</option>
                    <option value="EXECUTED">EXECUTED</option>
                    <option value="CANCELLED">CANCELLED</option>
                    <option value="OVERRIDDEN">OVERRIDDEN</option>
                </select>
            </label>
            <button id="btnLoadReq">Load</button>
            <span id="rqMsg" class="small"></span>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Created</th>
                    <th>RequestId</th>
                    <th>User</th>
                    <th>Totals (buy/sell/net)</th>
                    <th>Status</th>
                    <th>EditedFrom</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="rqTbody"></tbody>
        </table>
        <div id="rqDetails" class="small" style="white-space:pre-wrap;margin-top:8px;"></div>
    </div>

    <div class="section">
        <h2>OCM Trades (Pending)</h2>
        <div class="row">
            <button id="btnLoadTrades">Load</button>
            <span id="trMsg" class="small"></span>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Created</th>
                    <th>TradeId</th>
                    <th>Listing</th>
                    <th>Buyer</th>
                    <th>Qty</th>
                    <th>Price</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="trTbody"></tbody>
        </table>
    </div>

    <div class="section">
        <h2>Adjust Balance</h2>
        <div class="row grid2">
            <div>
                <div class="small">Pick user from adminListPlayers cache.</div>
                <input id="abUserQuery" type="text" placeholder="Type name/email to filter">
                <select id="abUserSelect" size="8" style="width:100%;"></select>
            </div>
            <div>
                <div class="row">
                    <label>Delta BT: <input id="abDelta" type="number" step="0.01" value="0"></label>
                </div>
                <div class="row">
                    <label>Reason: <input id="abReason" type="text" placeholder="Reason"></label>
                </div>
                <div class="row">
                    <button id="btnAdjust">Adjust</button>
                    <span id="abMsg" class="small"></span>
                </div>
            </div>
        </div>
    </div>

    <script>
        let googleIdToken = null;
        let __players = [];

        function fmt(n) { const x = Number(n) || 0; return x.toFixed(2).replace(/\.?0+$/, ''); }
        function byId(id) { return document.getElementById(id); }
        function normalizeResult(j) { return (j && j.result != null) ? j.result : (j && j.data != null ? j.data : j); }
        function shortUser(u) {
            if (!u) return '';
            return (u.playerName || u.email || u.userId || '').toString();
        }

        async function ensureAuth() {
            const st = byId('authStatus');
            const saved = window.getSavedIdToken && window.getSavedIdToken();
            if (!saved) { st.textContent = 'Not logged in. Open index.html and login.'; throw new Error('no token'); }
            googleIdToken = saved;
            try {
                const me = await apiGet('me', { idToken: googleIdToken });
                const d = normalizeResult(me);
                if (!d?.isAdmin) { st.textContent = 'You are not an admin.'; throw new Error('not admin'); }
                st.textContent = 'Admin authenticated: ' + (d?.user?.email || '');
                // load players for Adjust Balance
                const pl = await apiGet('adminListPlayers', { idToken: googleIdToken });
                const arr = Array.isArray(pl?.data) ? pl.data : (pl?.players || pl?.result?.players || []);
                __players = arr || [];
                renderPlayersList();
            } catch (e) {
                st.textContent = 'Auth failed: ' + (e.message || e);
                throw e;
            }
        }

        function renderPlayersList() {
            const q = (byId('abUserQuery').value || '').toLowerCase().trim();
            const sel = byId('abUserSelect'); sel.innerHTML = '';
            __players
                .map(p => ({ ...p, _k: (p.playerName || '') + ' ' + (p.email || '') + ' ' + (p.userId || '') }))
                .filter(p => !q || p._k.toLowerCase().includes(q))
                .slice(0, 200)
                .forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.userId || '';
                    opt.textContent = `${p.playerName || '(no name)'} â€” ${p.email || ''}`;
                    sel.appendChild(opt);
                });
        }

        async function loadPendingRequests() {
            const msg = byId('rqMsg'); msg.textContent = 'Loading...';
            const status = byId('rqStatus').value || '';
            try {
                const j = await apiGet('listPendingRequests', { idToken: googleIdToken, status });
                const d = normalizeResult(j);
                const rows = Array.isArray(d) ? d : (d?.requests || []);
                const tb = byId('rqTbody'); tb.innerHTML = '';
                rows.forEach(r => {
                    const tr = document.createElement('tr');
                    const totals = r?.totals || {};
                    tr.innerHTML = `
                    <td>${r.createdAt || ''}</td>
                    <td>${r.requestId || ''}</td>
                    <td>${shortUser(r.user)}</td>
                    <td>buy:${fmt(totals.buyBT)} sell:${fmt(totals.sellBT)} net:${fmt(totals.netBT)}</td>
                    <td>${r.status || 'PENDING'}</td>
                    <td>${r.editedFromRequestId || ''}</td>
                    <td>
                      <button data-act="view" data-id="${r.requestId}">View</button>
                      <button data-act="approve" data-id="${r.requestId}">Approve</button>
                      <button data-act="deny" data-id="${r.requestId}">Deny</button>
                      <button data-act="cancel" data-id="${r.requestId}">Cancel</button>
                    </td>
                  `;
                    tb.appendChild(tr);
                });
                msg.textContent = `Loaded ${rows.length}.`;
            } catch (e) {
                msg.textContent = 'Error: ' + (e.message || e);
            }
        }

        async function onRqAction(act, id) {
            const msg = byId('rqMsg');
            try {
                if (act === 'view') {
                    const j = await apiGet('getRequest', { idToken: googleIdToken, requestId: id });
                    const d = normalizeResult(j);
                    byId('rqDetails').textContent = JSON.stringify(d, null, 2);
                    return;
                }
                if (act === 'approve') {
                    await apiPost('approveRequest', { idToken: googleIdToken, requestId: id, note: '' });
                } else if (act === 'deny') {
                    await apiPost('denyRequest', { idToken: googleIdToken, requestId: id, note: '' });
                } else if (act === 'cancel') {
                    await apiPost('cancelRequest', { idToken: googleIdToken, requestId: id });
                }
                msg.textContent = 'OK.';
                await loadPendingRequests();
            } catch (e) {
                msg.textContent = 'Error: ' + (e.message || e);
            }
        }

        async function loadPendingTrades() {
            const msg = byId('trMsg'); msg.textContent = 'Loading...';
            try {
                const j = await apiGet('listTrades', { idToken: googleIdToken, status: 'PENDING' });
                const d = normalizeResult(j);
                const rows = Array.isArray(d) ? d : (d?.trades || []);
                const tb = byId('trTbody'); tb.innerHTML = '';
                rows.forEach(t => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                    <td>${t.createdAt || ''}</td>
                    <td>${t.tradeId || ''}</td>
                    <td>${t.itemName || ''} (${t.listingId || ''})</td>
                    <td>${shortUser(t.buyer)}</td>
                    <td>${t.quantity || 0}</td>
                    <td>${fmt(t.price || 0)} BT</td>
                    <td>${t.status || 'PENDING'}</td>
                    <td>
                      <button data-tr="approve" data-id="${t.tradeId}">Approve</button>
                      <button data-tr="deny" data-id="${t.tradeId}">Deny</button>
                    </td>
                  `;
                    tb.appendChild(tr);
                });
                msg.textContent = `Loaded ${rows.length}.`;
            } catch (e) {
                msg.textContent = 'Error: ' + (e.message || e);
            }
        }

        async function onTradeAction(act, id) {
            const msg = byId('trMsg');
            try {
                if (act === 'approve') await apiPost('approveTrade', { idToken: googleIdToken, tradeId: id });
                else if (act === 'deny') await apiPost('denyTrade', { idToken: googleIdToken, tradeId: id });
                msg.textContent = 'OK.';
                await loadPendingTrades();
            } catch (e) {
                msg.textContent = 'Error: ' + (e.message || e);
            }
        }

        async function doAdjustBalance() {
            const msg = byId('abMsg'); msg.textContent = 'Saving...';
            const sel = byId('abUserSelect');
            const userId = sel.value;
            const delta = Number(byId('abDelta').value || 0);
            const reason = (byId('abReason').value || '').trim();
            if (!userId) { msg.textContent = 'Pick a user first.'; return; }
            if (!isFinite(delta) || delta === 0) { msg.textContent = 'Enter non-zero delta.'; return; }
            try {
                await apiPost('adjustBalance', { idToken: googleIdToken, userId, deltaBT: delta, reason });
                msg.textContent = 'Adjusted.';
            } catch (e) {
                msg.textContent = 'Error: ' + (e.message || e);
            }
        }

        // Events
        document.addEventListener('click', (ev) => {
            const t = ev.target;
            if (t.dataset && t.dataset.act && t.dataset.id) onRqAction(t.dataset.act, t.dataset.id);
            if (t.dataset && t.dataset.tr && t.dataset.id) onTradeAction(t.dataset.tr, t.dataset.id);
        });
        byId('btnLoadReq').onclick = loadPendingRequests;
        byId('btnLoadTrades').onclick = loadPendingTrades;
        byId('btnAdjust').onclick = doAdjustBalance;
        byId('abUserQuery').oninput = renderPlayersList;

        (async () => {
            try { await ensureAuth(); } catch { return; }
            // auto-load
            loadPendingRequests();
            loadPendingTrades();
        })();
    </script>
</body>
</html>