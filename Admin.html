<!DOCTYPE html>
<html>
<head>
    <script src="auth-storage.js"></script>
    <meta charset="UTF-8">
    <title>Vak Store Admin</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: auto;
            background: #fafafa;
        }

        h1, h2, h3 {
            color: #333;
            margin-top: 0;
        }

        .section {
            margin-bottom: 28px;
            padding: 15px 18px 18px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background: #fff;
            position: relative;
        }

        label {
            display: inline-block;
            margin: 6px 12px 6px 0;
        }

        input[type="text"], input[type="number"], textarea {
            padding: 6px;
            margin: 6px 8px 6px 0;
            width: 220px;
            box-sizing: border-box;
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        button {
            padding: 6px 12px;
            margin: 6px 10px 6px 0;
            cursor: pointer;
            border: 1px solid #1a73e8;
            background: #1a73e8;
            color: #fff;
            border-radius: 4px;
            font-size: 14px;
        }

            button.secondary {
                background: #555;
                border-color: #555;
            }

            button.danger {
                background: #c0392b;
                border-color: #c0392b;
            }

            button:disabled {
                opacity: .55;
                cursor: not-allowed;
            }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 13px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 6px 8px;
            vertical-align: top;
        }

        th {
            background: #f6f7fb;
            text-align: left;
        }

        tr:hover {
            background: #f5faff;
        }

        .small {
            font-size: 12px;
            color: #555;
        }

        .ok {
            color: #2e7d32;
        }

        .err {
            color: #c00;
        }

        .row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
        }

        .pill {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 999px;
            background: #eee;
            font-size: 12px;
        }

        .muted {
            color: #777;
        }

        .inline-block {
            display: inline-block;
        }

        .flex-end {
            justify-content: flex-end;
        }

        .nowrap {
            white-space: nowrap;
        }

        .badge-admin {
            background: #1a73e8;
            color: #fff;
        }

        .status-chip {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            background: #eee;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: .5px;
        }

        .status-pending {
            background: #ffecb3;
        }

        .status-open {
            background: #e0f7fa;
        }

        .status-approved {
            background: #c8e6c9;
        }

        .status-rejected {
            background: #ffcdd2;
        }

        .filter-row input {
            width: 240px;
        }

        .slim-btn {
            padding: 3px 6px;
            font-size: 11px;
            margin: 0 4px 4px 0;
        }

        .danger.solid {
            background: #e53935;
        }

        .floating-msg {
            position: absolute;
            top: 10px;
            right: 14px;
            font-size: 11px;
        }

        .codebox {
            font-family: monospace;
            background: #f5f5f5;
            padding: 6px 8px;
            border-radius: 4px;
            white-space: pre-wrap;
        }

        .sticky-actions {
            position: sticky;
            top: 0;
            background: #fff;
            padding: 6px 0 4px;
            z-index: 5;
        }

        .soft-sep {
            border-top: 1px dashed #ddd;
            margin: 14px 0 10px;
            padding-top: 10px;
        }

        .fade-enter {
            animation: fade .35s ease;
        }

        @keyframes fade {
            from {
                opacity: 0;
                transform: translateY(4px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .pointer {
            cursor: pointer;
        }

        .nowrap-cell {
            white-space: nowrap;
        }

        .w80 {
            width: 80px;
        }

        .w100 {
            width: 100px;
        }

        .w60 {
            width: 60px;
        }

        .wide {
            width: 260px !important;
        }
    </style>
    <script src="app-config.js"></script>
</head>
<body>
    <h1>üîß Vak Store Admin</h1>
    <div id="authState" class="small"></div>

    <div class="section">
        <button onclick="goHome()">‚¨Ö Back to Store</button>
        <span id="adminBadge" class="pill badge-admin" style="display:none">Admin</span>
        <span id="adminEmail" class="small muted"></span>
        <div id="adminMsg" class="small"></div>
    </div>

    <!-- PLAYERS -->
    <div class="section" id="playersSec">
        <h2>üë• Players</h2>
        <div class="row filter-row">
            <input id="plSearch" type="text" placeholder="Search by player/email/userId/mailbox">
            <button onclick="refreshPlayers()">Refresh</button>
        </div>
        <div class="small muted">Click a row to copy userId.</div>
        <table id="playersTbl">
            <thead>
                <tr>
                    <th>UserId</th>
                    <th>Player</th>
                    <th>Email</th>
                    <th>Mailbox</th>
                    <th>Balance (BT)</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <div class="soft-sep"></div>
        <h3>Create Player (Manual)</h3>
        <div class="row">
            <label>Email <input id="cpEmail" type="text" placeholder="optional"></label>
            <label>Player Name <input id="cpName" type="text"></label>
            <label>Mailbox <input id="cpMailbox" type="text" placeholder="e.g. 1A"></label>
            <label>Balance <input id="cpBalance" type="number" step="0.01" value="0"></label>
            <button onclick="adminCreatePlayer()">Create</button>
            <span id="cpMsg" class="small"></span>
        </div>

        <h3>Adjust Funds</h3>
        <div class="row">
            <label>UserId <input id="afUserId" type="text" class="wide" placeholder="click row to copy then paste"></label>
            <label>Œî Balance (BT) <input id="afDelta" type="number" step="0.01" value="0"></label>
            <label>Reason <input id="afReason" type="text" placeholder="note"></label>
            <button onclick="adminAddFunds()">Apply</button>
            <span id="afMsg" class="small"></span>
        </div>

        <h3>Update Mailbox</h3>
        <div class="row">
            <label>Player Name <input id="umName" type="text"></label>
            <label>New Mailbox <input id="umMailbox" type="text"></label>
            <button onclick="adminUpdateMailbox()">Update</button>
            <span id="umMsg" class="small"></span>
        </div>
    </div>

    <!-- REQUESTS -->
    <div class="section" id="requestsSec">
        <h2>üì• Pending Requests</h2>
        <div class="row">
            <input id="rqFilter" type="text" placeholder="Filter by player/mailbox/requestId">
            <button onclick="refreshPending()">Refresh</button>
        </div>
        <table id="pendingTbl">
            <thead><tr><th>RequestId</th><th>Player</th><th>Mailbox</th><th>Items (brief)</th><th>Status</th><th>Open</th></tr></thead>
            <tbody></tbody>
        </table>

        <div id="rqDetailsBox" style="display:none;margin-top:14px;">
            <div class="sticky-actions">
                <h3 style="display:inline-block;margin-right:12px;">Request Details</h3>
                <label class="small"><input id="rqExecAdmin" type="checkbox"> Executed by admin (apply fee)</label>
                <button class="secondary" onclick="approveSelectedRequest()">Approve</button>
                <button class="danger" onclick="rejectSelectedRequest()">Reject</button>
                <span id="rqActMsg" class="small"></span>
            </div>
            <div id="rqDetails" class="small codebox fade-enter"></div>
        </div>
    </div>

    <!-- CLAIMS -->
    <div class="section" id="claimsSec">
        <h2>üßæ Account Claims</h2>
        <div class="row">
            <button onclick="refreshClaims()">Refresh</button>
        </div>
        <table id="claimsTbl">
            <thead>
                <tr><th>ClaimId</th><th>Requester</th><th>TargetRef</th><th>MatchedUserId</th><th>Player</th><th>Mailbox</th><th>Actions</th></tr>
            </thead>
            <tbody></tbody>
        </table>
        <div id="claimsMsg" class="small"></div>
    </div>

    <!-- LISTINGS -->
    <div class="section" id="listingsSec">
        <h2>üìã OCM Listings (Pending)</h2>
        <div class="row">
            <button onclick="refreshListingsPending()">Refresh</button>
        </div>
        <table id="listingsTbl">
            <thead>
                <tr><th>ListingId</th><th>Type</th><th>Item</th><th>Price</th><th>Remaining</th><th>Seller</th><th>Approve</th></tr>
            </thead>
            <tbody></tbody>
        </table>
        <div id="listingsMsg" class="small"></div>
    </div>

    <!-- TRADES -->
    <div class="section" id="tradesSec">
        <h2>üîÅ OCM Trades (Pending Admin)</h2>
        <div class="row">
            <button onclick="refreshTradesPending()">Refresh</button>
        </div>
        <table id="tradesTbl">
            <thead>
                <tr><th>TradeId</th><th>ListingId</th><th>Qty</th><th>Price</th><th>Status</th><th>Player</th><th>Actions</th></tr>
            </thead>
            <tbody></tbody>
        </table>
        <div id="tradesMsg" class="small"></div>
    </div>

    <script>
        const WEB_APP_URL = window.WEB_APP_URL || 'https://yellow-king-52c6.vilhokettu1.workers.dev/exec';
        let googleIdToken = null;
        let selectedRequestId = null;

        function goHome() { location.href = 'index.html'; }

        function postAction(action, payload) {
            return fetch(WEB_APP_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action, idToken: googleIdToken, payload })
            }).then(r => r.json());
        }

        async function ensureAdmin() {
            const auth = await (window.initAuthFromStorage ? window.initAuthFromStorage() : Promise.resolve({ ok: false }));
            if (!auth.ok) {
                document.getElementById('authState').innerHTML = '<span class="err">Not logged in. Login on Store page.</span>';
                return false;
            }
            googleIdToken = auth.idToken;
            try {
                const meR = await fetch(`${WEB_APP_URL}?action=me&idToken=${encodeURIComponent(googleIdToken)}`);
                const meJ = await meR.json();
                if (!meJ.ok) throw new Error(meJ.error || 'me failed');
                document.getElementById('adminEmail').textContent = meJ.data.user?.email || '';
                if (!meJ.data.isAdmin) {
                    document.getElementById('authState').innerHTML = '<span class="err">Access denied (not admin).</span>';
                    return false;
                }
                document.getElementById('authState').innerHTML = '<span class="ok">Admin authenticated.</span>';
                document.getElementById('adminBadge').style.display = 'inline-block';
                return true;
            } catch (e) {
                document.getElementById('authState').innerHTML = '<span class="err">Auth error: ' + e.message + '</span>';
                return false;
            }
        }

        /* ===== Players ===== */
        async function refreshPlayers() {
            const tbody = document.querySelector('#playersTbl tbody');
            tbody.innerHTML = '';
            try {
                const r = await fetch(`${WEB_APP_URL}?action=adminListPlayers&idToken=${encodeURIComponent(googleIdToken)}`);
                const j = await r.json();
                if (!j.ok) throw new Error(j.error);
                const list = Array.isArray(j.data) ? j.data : (j.data.players || []);
                const q = (document.getElementById('plSearch').value || '').toLowerCase().trim();
                list.filter(p => {
                    if (!q) return true;
                    const hay = `${p.userId} ${p.playerName || ''} ${p.email || ''} ${p.mailbox || ''}`.toLowerCase();
                    return hay.indexOf(q) >= 0;
                }).forEach(p => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td class="small nowrap-cell">${p.userId}</td>
                                        <td>${p.playerName || ''}</td>
                                        <td>${p.email || ''}</td>
                                        <td>${p.mailbox || ''}</td>
                                        <td class="small">${Number(p.balanceBT || 0).toFixed(2)}</td>`;
                    tr.onclick = () => {
                        navigator.clipboard.writeText(p.userId).catch(() => { });
                        const am = document.getElementById('adminMsg');
                        am.textContent = 'Copied userId: ' + p.userId;
                        setTimeout(() => { if (am.textContent.startsWith('Copied')) am.textContent = ''; }, 2500);
                    };
                    tbody.appendChild(tr);
                });
            } catch (e) {
                document.getElementById('adminMsg').textContent = 'Players load error: ' + e.message;
            }
        }
        async function adminCreatePlayer() {
            const msg = document.getElementById('cpMsg'); msg.textContent = 'Working...';
            try {
                const res = await postAction('adminCreatePlayer', {
                    email: document.getElementById('cpEmail').value.trim(),
                    playerName: document.getElementById('cpName').value.trim(),
                    mailbox: document.getElementById('cpMailbox').value.trim(),
                    balanceBT: parseFloat(document.getElementById('cpBalance').value) || 0
                });
                if (!res.ok) throw new Error(res.error);
                msg.textContent = 'Created userId=' + res.result.userId;
                refreshPlayers();
            } catch (e) { msg.textContent = 'Error: ' + e.message; }
        }
        async function adminAddFunds() {
            const msg = document.getElementById('afMsg'); msg.textContent = 'Working...';
            try {
                const res = await postAction('adminAddFunds', {
                    userId: document.getElementById('afUserId').value.trim(),
                    deltaBT: parseFloat(document.getElementById('afDelta').value) || 0,
                    reason: document.getElementById('afReason').value.trim()
                });
                if (!res.ok) throw new Error(res.error);
                msg.textContent = 'OK. New balance: ' + Number(res.result.balanceAfter).toFixed(2);
                refreshPlayers();
            } catch (e) { msg.textContent = 'Error: ' + e.message; }
        }
        async function adminUpdateMailbox() {
            const msg = document.getElementById('umMsg'); msg.textContent = 'Working...';
            try {
                const res = await postAction('adminUpdateMailbox', {
                    playerName: document.getElementById('umName').value.trim(),
                    mailbox: document.getElementById('umMailbox').value.trim()
                });
                if (!res.ok) throw new Error(res.error);
                msg.textContent = 'Updated.';
                refreshPlayers();
            } catch (e) { msg.textContent = 'Error: ' + e.message; }
        }

        /* ===== Requests ===== */
        async function refreshPending() {
            const tbody = document.querySelector('#pendingTbl tbody');
            tbody.innerHTML = '';
            document.getElementById('rqDetailsBox').style.display = 'none';
            selectedRequestId = null;
            try {
                const f = document.getElementById('rqFilter').value.trim();
                const r = await fetch(`${WEB_APP_URL}?action=pending&idToken=${encodeURIComponent(googleIdToken)}&filter=${encodeURIComponent(f)}`);
                const j = await r.json();
                if (!j.ok) throw new Error(j.error);
                (j.data || []).forEach(x => {
                    const brief = (x.items || [])
                        .map(i => `${i.side}:${i.itemName}√ó${i.quantity}@${i.price}`)
                        .slice(0, 3).join(' | ');
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${x.requestId}</td>
                                        <td>${x.playerName || ''}</td>
                                        <td>${x.mailboxNumber || ''}</td>
                                        <td class="small">${brief}</td>
                                        <td><span class="status-chip status-${(x.status || '').toLowerCase()}">${x.status}</span></td>
                                        <td><button class="slim-btn" data-id="${x.requestId}">Open</button></td>`;
                    tr.querySelector('button').onclick = () => openRequestDetails(x.requestId);
                    tbody.appendChild(tr);
                });
            } catch (e) {
                document.getElementById('adminMsg').textContent = 'Pending load error: ' + e.message;
            }
        }
        async function openRequestDetails(requestId) {
            selectedRequestId = requestId;
            const box = document.getElementById('rqDetailsBox');
            const el = document.getElementById('rqDetails');
            el.textContent = 'Loading...';
            box.style.display = 'block';
            try {
                const r = await fetch(`${WEB_APP_URL}?action=requestDetails&idToken=${encodeURIComponent(googleIdToken)}&requestId=${encodeURIComponent(requestId)}`);
                const j = await r.json();
                if (!j.ok) throw new Error(j.error);
                const d = j.data;
                const lines = (d.items || []).map(i => `- ${i.side} ${i.itemName} √ó ${i.quantity} @ ${i.price}`).join('\n');
                el.innerHTML =
                    `RequestId: ${d.requestId}
Player: ${d.playerName} (${d.mailboxNumber})
Status: ${d.status}
Balance: ${Number(d.userBalanceBT || 0).toFixed(2)} BT

Items:
${lines}

Totals: buyBT=${Number(d.buyBT || 0).toFixed(2)} sellBT=${Number(d.sellBT || 0).toFixed(2)} netBT=${Number(d.netBT || 0).toFixed(2)}
`;
                document.getElementById('rqActMsg').textContent = '';
            } catch (e) {
                el.textContent = 'Error: ' + e.message;
            }
        }
        async function approveSelectedRequest() {
            const msg = document.getElementById('rqActMsg');
            if (!selectedRequestId) { msg.textContent = 'Open a request first.'; return; }
            msg.textContent = 'Working...';
            try {
                const executedByAdmin = document.getElementById('rqExecAdmin').checked;
                const res = await postAction('approveRequest', { requestId: selectedRequestId, executedByAdmin });
                if (!res.ok) throw new Error(res.error);
                msg.textContent = `Approved. netBT=${res.result.netBT} fee=${res.result.feeBT}`;
                refreshPending();
            } catch (e) { msg.textContent = 'Error: ' + e.message; }
        }
        async function rejectSelectedRequest() {
            const msg = document.getElementById('rqActMsg');
            if (!selectedRequestId) { msg.textContent = 'Open a request first.'; return; }
            if (!confirm('Reject this request?')) return;
            msg.textContent = 'Working...';
            try {
                const res = await postAction('rejectRequest', { requestId: selectedRequestId, note: '' });
                if (!res.ok) throw new Error(res.error);
                msg.textContent = 'Rejected.';
                refreshPending();
            } catch (e) { msg.textContent = 'Error: ' + e.message; }
        }

        /* ===== Claims ===== */
        async function refreshClaims() {
            const tbody = document.querySelector('#claimsTbl tbody');
            const msg = document.getElementById('claimsMsg');
            tbody.innerHTML = ''; msg.textContent = '';
            try {
                const r = await fetch(`${WEB_APP_URL}?action=adminListAccountClaims&idToken=${encodeURIComponent(googleIdToken)}`);
                const j = await r.json();
                if (!j.ok) throw new Error(j.error);
                (j.data || []).forEach(c => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                            <td class="small">${c.claimId}</td>
                            <td class="small">${c.requesterUserId}<div class="muted">${c.requesterEmail || ''}</div></td>
                            <td>${c.targetRef}</td>
                            <td class="small">${c.matchedUserId || ''}</td>
                            <td>${c.playerName || ''}</td>
                            <td>${c.mailbox || ''}</td>
                            <td>
                                <button class="slim-btn" data-c="${c.claimId}">Approve</button>
                                <button class="slim-btn danger" data-cr="${c.claimId}">Reject</button>
                            </td>`;
                    tr.querySelector('button[data-c]').onclick = () => resolveClaim(c.claimId, true);
                    tr.querySelector('button[data-cr]').onclick = () => resolveClaim(c.claimId, false);
                    tbody.appendChild(tr);
                });
            } catch (e) { msg.textContent = 'Claims load error: ' + e.message; }
        }
        async function resolveClaim(claimId, approve) {
            const msg = document.getElementById('claimsMsg');
            msg.textContent = 'Working...';
            try {
                const res = await postAction('adminResolveAccountClaim', { claimId, approve, note: '' });
                if (!res.ok) throw new Error(res.error);
                msg.textContent = approve ? 'Claim approved & merged.' : 'Claim rejected.';
                refreshClaims();
            } catch (e) { msg.textContent = 'Error: ' + e.message; }
        }

        /* ===== Listings ===== */
        async function refreshListingsPending() {
            const tbody = document.querySelector('#listingsTbl tbody');
            const msg = document.getElementById('listingsMsg');
            tbody.innerHTML = ''; msg.textContent = '';
            try {
                const r = await fetch(`${WEB_APP_URL}?action=adminListingsPending&idToken=${encodeURIComponent(googleIdToken)}`);
                const j = await r.json();
                if (!j.ok) throw new Error(j.error);
                (j.data || []).forEach(l => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                            <td class="small">${l.listingId}</td>
                            <td>${l.type}</td>
                            <td>${l.itemName}</td>
                            <td><input class="w80" type="number" step="0.01" value="${l.price || 0}"></td>
                            <td><input class="w80" type="number" step="1" value="${l.remainingQuantity || l.quantity || 0}"></td>
                            <td>${l.sellerPlayerName || ''}</td>
                            <td><button class="slim-btn" data-l="${l.listingId}">Approve</button></td>`;
                    const inputs = tr.querySelectorAll('input');
                    tr.querySelector('button[data-l]').onclick = () =>
                        approveListing(l.listingId, inputs[0].value, inputs[1].value);
                    tbody.appendChild(tr);
                });
            } catch (e) { msg.textContent = 'Listings load error: ' + e.message; }
        }
        async function approveListing(listingId, price, remainingQuantity) {
            const msg = document.getElementById('listingsMsg');
            msg.textContent = 'Working...';
            try {
                const res = await postAction('adminApproveListing', {
                    listingId,
                    updates: { price: Number(price), remainingQuantity: Number(remainingQuantity) }
                });
                if (!res.ok) throw new Error(res.error);
                msg.textContent = 'Listing approved.';
                refreshListingsPending();
            } catch (e) { msg.textContent = 'Error: ' + e.message; }
        }

        /* ===== Trades ===== */
        async function refreshTradesPending() {
            const tbody = document.querySelector('#tradesTbl tbody');
            const msg = document.getElementById('tradesMsg');
            tbody.innerHTML = ''; msg.textContent = '';
            try {
                const r = await fetch(`${WEB_APP_URL}?action=adminTradesPending&idToken=${encodeURIComponent(googleIdToken)}`);
                const j = await r.json();
                if (!j.ok) throw new Error(j.error);
                (j.data || []).forEach(t => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                            <td class="small">${t.tradeId}</td>
                            <td class="small">${t.listingId}</td>
                            <td>${t.quantity}</td>
                            <td>${Number(t.price).toFixed(2)}</td>
                            <td><span class="status-chip status-${(t.status || '').toLowerCase()}">${t.status}</span></td>
                            <td>${t.playerName || ''}</td>
                            <td>
                                <button class="slim-btn" data-t="${t.tradeId}">Approve</button>
                                <button class="slim-btn danger" data-tr="${t.tradeId}">Reject</button>
                            </td>`;
                    tr.querySelector('button[data-t]').onclick = () => approveTrade(t.tradeId);
                    tr.querySelector('button[data-tr]').onclick = () => rejectTrade(t.tradeId);
                    tbody.appendChild(tr);
                });
            } catch (e) { msg.textContent = 'Trades load error: ' + e.message; }
        }
        async function approveTrade(tradeId) {
            const msg = document.getElementById('tradesMsg');
            msg.textContent = 'Working...';
            try {
                const res = await postAction('adminApproveTrade', { tradeId });
                if (!res.ok) throw new Error(res.error);
                msg.textContent = 'Trade approved.';
                refreshTradesPending();
            } catch (e) { msg.textContent = 'Error: ' + e.message; }
        }
        async function rejectTrade(tradeId) {
            if (!confirm('Reject this trade?')) return;
            const msg = document.getElementById('tradesMsg');
            msg.textContent = 'Working...';
            try {
                const res = await postAction('adminRejectTrade', { tradeId, note: '' });
                if (!res.ok) throw new Error(res.error);
                msg.textContent = 'Trade rejected.';
                refreshTradesPending();
            } catch (e) { msg.textContent = 'Error: ' + e.message; }
        }

        /* ===== Init ===== */
        window.onload = async () => {
            const ok = await ensureAdmin();
            if (!ok) return;
            // Initial loads (parallel)
            refreshPlayers();
            refreshPending();
            refreshClaims();
            refreshListingsPending();
            refreshTradesPending();
        };
    </script>
</body>
</html>