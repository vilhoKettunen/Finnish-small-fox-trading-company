<!DOCTYPE html>
<html lang="en">
<head>
    <script src="auth-storage.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Item Market Tracker</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="app-config.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="topbar.js"></script>

    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            padding:1rem;
            background: #fafafa;
            color: #333;
        }

        body.withTopBar {
            padding-top:72px;
        }

        h1 {
            margin-bottom:1rem;
            color: #222;
        }

        /* --- CONTROLS BAR --- */
        #controls {
            display: flex;
            flex-wrap: wrap;
            gap:1rem;
            align-items: flex-end;
            background: #fff;
            padding:1rem;
            border-radius:12px;
            box-shadow:02px8px rgba(0,0,0,0.05);
            margin-bottom:1.5rem;
        }

        label {
            display: flex;
            flex-direction: column;
            gap:0.3rem;
            font-weight:500;
            font-size:0.85rem;
            color: #666;
        }

        select, input[list], button {
            padding: .5rem .7rem;
            border:1px solid #ddd;
            border-radius:6px;
            font-size:0.95rem;
            outline: none;
        }

        select:focus, input:focus {
            border-color: #007bff;
        }

        button {
            cursor: pointer;
            background: #fff;
        }

        button.primary {
            background: #111827;
            color: #fff;
            border-color: #111827;
        }

        button.primary:hover {
            filter: brightness(1.05);
        }

        .itemSelectBlock {
            display: flex;
            flex-direction: column;
            gap: .5rem;
            flex-grow:1;
            min-width:320px;
            max-width:520px;
        }

        .itemSelectRow {
            display: flex;
            gap: .5rem;
            align-items: center;
        }

        .selectWithInfo {
            display: flex;
            gap: .5rem;
            align-items: flex-end;
        }

        #selectedItemsChips {
            display: flex;
            flex-wrap: wrap;
            gap: .5rem;
            min-height:32px;
            padding-top: .25rem;
        }

        .chip {
            display: inline-flex;
            align-items: center;
            gap: .4rem;
            padding: .25rem .5rem;
            border:1px solid #eee;
            border-radius:999px;
            background: #fafafa;
        }

        .chipColor {
            width:10px;
            height:10px;
            border-radius:2px;
        }

        .chipText {
            font-size: .9rem;
            font-weight:600;
        }

        .chipRemove {
            border: none;
            background: transparent;
            font-size:1rem;
            line-height:1;
            padding:0 .15rem;
            color: #dc2626;
            font-weight:900;
        }

        .chipRemove:hover {
            color: #b91c1c;
        }

        #warningBox {
            display: none;
            width:100%;
            padding: .6rem .75rem;
            border-radius:8px;
            background: #fff7ed;
            border:1px solid #fed7aa;
            color: #9a3412;
            font-size: .9rem;
        }

        #selectedItemImages {
            display: flex;
            align-items: center;
            gap: .35rem;
            margin-left: auto;
        }

        .itemThumb {
            width:34px;
            height:34px;
            object-fit: contain;
            border-radius:8px;
            border:1px solid #eee;
            background: #fff;
        }

        .moreCount {
            color: #6b7280;
            font-size: .85rem;
        }

        .toggles {
            display: flex;
            flex-direction: column;
            gap: .35rem;
            padding-left: .25rem;
        }

        .toggleRow {
            display: flex;
            gap: .5rem;
            align-items: center;
            font-size: .85rem;
            color: #374151;
        }

        .infoBtn {
            border:1px solid #ddd;
            background: #fff;
            border-radius:8px;
            padding: .35rem .6rem;
            font-weight:700;
            color: #111827;
            font-size: .85rem;
            white-space: nowrap;
        }

        .infoBtn:hover {
            border-color: #cbd5e1;
        }

        /* --- CHART CONTAINERS --- */
        #charts {
            display: flex;
            flex-direction: column;
            gap:2rem;
        }

        .chart-card {
            background: white;
            border-radius:12px;
            padding:1rem;
            box-shadow:04px12px rgba(0,0,0,0.08);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom:0.75rem;
            padding-bottom:0.5rem;
            border-bottom:1px solid #eee;
            gap:1rem;
        }

        .chart-title {
            font-weight:700;
            color: #444;
            font-size:1.1rem;
            display: flex;
            align-items: center;
            gap: .5rem;
        }

        .chart-meta {
            font-size:0.85rem;
            color: #888;
        }

        .chart-body {
            display: grid;
            grid-template-columns:1fr220px;
            gap:1rem;
            align-items: start;
        }

        .chart-wrapper {
            position: relative;
            height:400px;
            width:100%;
        }

        canvas {
            display: block;
            width:100%;
            height:100%;
        }

        .legend {
            border-left:1px solid #eee;
            padding-left:1rem;
            max-height:400px;
            overflow: auto;
        }

        .legendRow {
            display: flex;
            align-items: center;
            gap: .5rem;
            margin-bottom: .4rem;
        }

        .legendSwatch {
            width:12px;
            height:12px;
            border-radius:3px;
            flex:00 auto;
        }

        .legendLabel {
            font-size: .9rem;
            font-weight:700;
            word-break: break-word;
        }

        /* Modal */
        #infoModal {
            display: none;
            position: fixed;
            inset:0;
            background: rgba(0,0,0,0.45);
            align-items: center;
            justify-content: center;
            padding:1rem;
            z-index:9999;
        }

        .modalCard {
            width: min(720px,95vw);
            background: #fff;
            border-radius:12px;
            padding:1rem;
            box-shadow:08px30px rgba(0,0,0,0.25);
        }

        .modalHeader {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap:1rem;
            margin-bottom: .5rem;
        }

        .modalTitle {
            font-weight:800;
            color: #111827;
            font-size:1.1rem;
        }

        .modalClose {
            border:1px solid #ddd;
            background: #fff;
            border-radius:8px;
            padding: .35rem .6rem;
        }

        .helpExample {
            margin-top: .75rem;
            padding: .75rem;
            border-radius:10px;
            background: #f9fafb;
            border:1px solid #eee;
        }

        .helpExampleTitle {
            font-weight:800;
            margin-bottom: .25rem;
        }

        @media (max-width:880px) {
            .chart-body {
                grid-template-columns:1fr;
            }
            .legend {
                border-left: none;
                padding-left:0;
                border-top:1px solid #eee;
                padding-top:1rem;
                max-height:180px;
            }
        }
    </style>
</head>

<body>
    <h1>Item Market History</h1>

    <div id="controls">
        <label>
            Sheet (Buy/Sell):
            <select id="typeSelect">
                <option value="SellHistory" selected>Buy Prices (SellHistory)</option>
                <option value="BuyHistory">Sell Prices (BuyHistory)</option>
            </select>
        </label>

        <div class="itemSelectBlock">
            <div style="display:flex; align-items:center; gap:.5rem;">
                <div style="font-weight:700; color:#374151;">Items</div>
                <button class="infoBtn" type="button" data-info="controls" title="How to use">More info</button>
            </div>

            <div class="itemSelectRow">
                <input id="itemSearchInput" list="itemDatalist" placeholder="Search items..." style="flex:1;" />
                <datalist id="itemDatalist"></datalist>
                <button id="addItemBtn" type="button">Add</button>
                <button id="applyItemsBtn" type="button" class="primary">Apply</button>
                <button id="clearItemsBtn" type="button">Clear</button>
            </div>

            <div id="selectedItemsChips"></div>
        </div>

        <label>
            Time Range:
            <select id="rangeSelect">
                <option value="7">Last7 days</option>
                <option value="30">Last30 days</option>
                <option value="180">Last6 months</option>
                <option value="365">Last year</option>
                <option value="all" selected>All history</option>
            </select>
        </label>

        <div class="selectWithInfo">
            <label>
                Middle Chart Metric:
                <select id="metricSelect">
                    <option value="stock" selected>Stock Amount</option>
                    <option value="change">Daily Price Change (+/-)</option>
                    <option value="changePct">Daily Price Change (%)</option>
                    <option value="valuation">Total Valuation</option>
                    <option value="goal">Goal Stock %</option>
                    <option value="targetStock">Target stock stack</option>
                </select>
            </label>
            <button class="infoBtn" type="button" data-info="metricSystem" title="About metrics">More info (metrics)</button>
        </div>

        <div class="selectWithInfo">
            <label>
                Inflation Index Category:
                <select id="indexSelect">
                    <option value="median" selected>Median Item Inflation Index (Weighted)</option>
                    <option value="metals">Metal Index (Weighted)</option>
                    <option value="common">Common Items Index (Weighted)</option>
                    <option value="selected">Selected items index (Weighted)</option>
                </select>
            </label>
            <button class="infoBtn" type="button" data-info="indexSystem" title="About categories">More info (categories)</button>
        </div>

        <div id="selectedItemImages" aria-label="Selected item images"></div>

        <div id="warningBox" role="status" aria-live="polite"></div>
    </div>

    <div id="charts">
        <div class="chart-card">
            <div class="chart-header">
                <div>
                    <div class="chart-title">
                        Price Trend
                        <button class="infoBtn" type="button" data-info="price" title="About Price Trend">More info</button>
                    </div>
                    <div class="chart-meta">History of recorded prices</div>
                </div>
                <div class="toggles">
                    <label class="toggleRow"><input type="checkbox" id="toggleCombinedPrice" /> Show combined</label>
                    <label class="toggleRow"><input type="checkbox" id="toggleNormalizeCombined" /> Normalize combined to100</label>
                </div>
            </div>
            <div class="chart-body">
                <div class="chart-wrapper">
                    <canvas id="priceChart"></canvas>
                </div>
                <div class="legend" id="priceLegend" aria-label="Price chart legend"></div>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-header">
                <div>
                    <div class="chart-title" id="middleChartTitle">
                        Stock History
                        <button class="infoBtn" type="button" data-info="middleDynamic" title="About this metric">More info</button>
                    </div>
                    <div class="chart-meta" id="middleChartDesc">Metric for selected items</div>
                </div>
                <div class="toggles">
                    <label class="toggleRow"><input type="checkbox" id="toggleCombinedMiddle" /> Show combined sum</label>
                </div>
            </div>
            <div class="chart-body">
                <div class="chart-wrapper">
                    <canvas id="metricChart"></canvas>
                </div>
                <div class="legend" id="middleLegend" aria-label="Middle chart legend"></div>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-header">
                <div>
                    <div class="chart-title" id="inflationChartTitle">
                        Inflation Index (base=100)
                        <button class="infoBtn" type="button" data-info="inflationDynamic" title="About this category">More info</button>
                    </div>
                    <div class="chart-meta" id="inflationChartDesc">
                        Weighted median of per-item price inflation factors. Weight = stock value (BT)/1000 (prefers ValuationHistory; falls back to stock*price).
                    </div>
                </div>
            </div>
            <div class="chart-wrapper">
                <canvas id="inflationChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Info Modal -->
    <div id="infoModal" role="dialog" aria-modal="true" aria-labelledby="infoModalTitle">
        <div class="modalCard">
            <div class="modalHeader">
                <div class="modalTitle" id="infoModalTitle">Info</div>
                <button class="modalClose" id="infoModalClose" type="button">Close</button>
            </div>
            <div id="infoModalBody"></div>
        </div>
    </div>

    <!-- PriceHistory scripts -->
    <script src="pricehistory_js/pricehistory-config.js"></script>
    <script src="pricehistory_js/pricehistory-utils.js"></script>
    <script src="pricehistory_js/pricehistory-data.js"></script>
    <script src="pricehistory_js/pricehistory-processing.js"></script>
    <script src="pricehistory_js/pricehistory-charts.js"></script>
    <script src="pricehistory_js/pricehistory-helptext.js"></script>
    <script src="pricehistory_js/pricehistory-storage.js"></script>
    <script src="pricehistory_js/pricehistory-ui.js"></script>
    <script src="pricehistory_js/pricehistory-boot.js"></script>
</body>
</html>