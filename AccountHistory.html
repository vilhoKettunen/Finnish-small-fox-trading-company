<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Account History</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 1000px;
            margin: auto;
        }

        .row {
            margin: 8px 0;
        }

        table {
            border-collapse: collapse;
            width: 100%;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 6px;
        }

        th {
            background: #f5f5f5;
        }

        .small {
            font-size: 12px;
            color: #555;
        }

        input, select, button {
            padding: 6px;
        }
    </style>
    <script src="app-config.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="topbar.js"></script>
    <script src="api-client.js"></script>
</head>
<body>
    <h1>Account History</h1>
    <div id="authStatus" class="small">Checking auth...</div>

    <div class="row">
        <label>From: <input id="dtFrom" type="date"></label>
        <label>To: <input id="dtTo" type="date"></label>
        <label>
            Page size:
            <select id="pgSize">
                <option>20</option>
                <option selected>50</option>
                <option>100</option>
            </select>
        </label>
        <button id="btnLoad">Load</button>
        <span id="msg" class="small"></span>
    </div>

    <table>
        <thead>
            <tr>
                <th>Date</th>
                <th>TxId</th>
                <th>Type</th>
                <th>Delta BT</th>
                <th>Balance After</th>
                <th>Details</th>
            </tr>
        </thead>
        <tbody id="tb"></tbody>
    </table>

    <div class="row">
        <button id="prev">Prev</button>
        <span id="pgInfo" class="small"></span>
        <button id="next">Next</button>
    </div>

    <script>
        let googleIdToken = null;
        let page = 1;

        function byId(x) { return document.getElementById(x); }
        function fmt(n) { const v = Number(n) || 0; return v.toFixed(2).replace(/\.?0+$/, ''); }
        function normalizeResult(j) { return (j && j.result != null) ? j.result : (j && j.data != null ? j.data : j); }

        async function ensureAuth() {
            const st = byId('authStatus');
            const saved = window.getSavedIdToken && window.getSavedIdToken();
            if (!saved) { st.textContent = 'Not logged in. Open index.html and login.'; throw new Error('no token'); }
            googleIdToken = saved;
            try {
                const me = await apiGet('me', { idToken: googleIdToken });
                const d = normalizeResult(me);
                st.textContent = 'Logged as ' + (d?.user?.email || '');
            } catch (e) {
                st.textContent = 'Auth failed: ' + (e.message || e);
                throw e;
            }
        }

        async function loadHistory() {
            const msg = byId('msg'); msg.textContent = 'Loading...';
            const size = Number(byId('pgSize').value || 50);
            const since = byId('dtFrom').value || '';
            const until = byId('dtTo').value || '';
            try {
                const j = await apiGet('getHistory', { idToken: googleIdToken, page, pageSize: size, since, until });
                const d = normalizeResult(j);
                const arr = Array.isArray(d) ? d : (d?.items || []);
                const total = Number(d?.total || 0);
                const tb = byId('tb'); tb.innerHTML = '';
                arr.forEach(h => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                    <td>${h.at || ''}</td>
                    <td>${h.txId || ''}</td>
                    <td>${h.type || ''}</td>
                    <td>${fmt(h.deltaBT || 0)}</td>
                    <td>${fmt(h.balanceAfterBT || 0)}</td>
                    <td><pre class="small" style="white-space:pre-wrap;margin:0">${(h.detailsJson || '')}</pre></td>
                  `;
                    tb.appendChild(tr);
                });
                const pages = total && size ? Math.ceil(total / size) : (arr.length < size ? page : page + 1);
                byId('pgInfo').textContent = `Page ${page} / ${pages || '?'}`;
                msg.textContent = `Loaded ${arr.length}.`;
            } catch (e) {
                msg.textContent = 'Error: ' + (e.message || e);
            }
        }

        byId('btnLoad').onclick = () => { page = 1; loadHistory(); };
        byId('prev').onclick = () => { if (page > 1) { page--; loadHistory(); } };
        byId('next').onclick = () => { page++; loadHistory(); };

        (async () => { try { await ensureAuth(); loadHistory(); } catch { } })();
    </script>
</body>
</html>